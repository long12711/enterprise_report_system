# 企业用户填报流程说明

## 📋 流程概述

企业用户登录后，按照初级→中级→高级的顺序填写调查问卷，提交后自动计算得分、生成自评报告，并通过邮箱发送报告。

---

## 🔄 完整流程图

```
┌─────────────────────────────────────────────────────────┐
│  1. 企业用户登录                                          │
│     - 输入企业账号密码                                    │
│     - 验证身份                                            │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  2. 进入企业门户                                          │
│     - 显示企业信息                                        │
│     - 显示待填问卷列表                                    │
│     - 显示历史填报记录                                    │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  3. 填写初级问卷                                          │
│     - 显示初级评价指标                                    │
│     - 企业填写答案                                        │
│     - 支持保存草稿                                        │
│     - 提交问卷                                            │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  4. 初级问卷评分                                          │
│     - 自动计算得分                                        │
│     - 转换为百分制                                        │
│     - 判断是否合格（≥60分）                               │
└─────────────────────────────────────────────────────────┘
                            ↓
                    ┌───────┴───────┐
                    │               │
            合格（≥60分）      不合格（<60分）
                    │               │
                    ↓               ↓
        ┌───────────────┐   ┌──────────────┐
        │ 解锁中级问卷   │   │ 停止，无法   │
        │               │   │ 填写下一级   │
        └───────────────┘   └──────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  5. 填写中级问卷                                          │
│     - 显示中级评价指标                                    │
│     - 企业填写答案                                        │
│     - 提交问卷                                            │
└─────────────────────────────────────────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  6. 中级问卷评分                                          │
│     - 自动计算得分                                        │
│     - 判断是否合格                                        │
└─────────────────────────────────────────────────────────┘
                    │
                    ↓
            合格 → 解锁高级问卷
            不合格 → 停止
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  7. 填写高级问卷                                          │
│     - 显示高级评价指标                                    │
│     - 企业填写答案                                        │
│     - 提交问卷                                            │
└─────────────────────────────────────────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  8. 生成自评报告                                          │
│     - 读取工商联提供的报告模板                            │
│     - 填充企业数据                                        │
│     - 计算各维度得分                                      │
│     - 生成改进建议                                        │
│     - 生成Word格式报告                                    │
└─────────────────────────────────────────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  9. 显示结果页面                                          │
│     - 显示百分制得分                                      │
│     - 显示评价等级                                        │
│     - 提供报告下载链接                                    │
│     - 显示邮件发送状态                                    │
└─────────────────────────────────────────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────┐
│  10. 发送邮件                                             │
│      - 异步发送到企业邮箱                                 │
│      - 附件包含自评报告                                   │
│      - 邮件包含得分信息                                   │
└─────────────────────────────────────────────────────────┘
```

---

## 📝 详细功能说明

### 1. 企业用户登录
**页面**: `/login` 或 `/portal/enterprise`

**功能**:
- 企业账号密码登录
- 记住登录状态
- 首次登录引导

**实现状态**: ✅ 已实现

---

### 2. 企业门户首页
**页面**: `/portal/enterprise`

**显示内容**:
```
┌─────────────────────────────────────────┐
│  欢迎，【企业名称】                      │
├─────────────────────────────────────────┤
│  待填问卷：                              │
│  □ 初级问卷 [开始填写]                  │
│  □ 中级问卷 [未解锁]                    │
│  □ 高级问卷 [未解锁]                    │
├─────────────────────────────────────────┤
│  历史记录：                              │
│  - 2025-11-26 初级问卷 85分 [查看报告]  │
│  - 2025-10-15 初级问卷 72分 [查看报告]  │
└─────────────────────────────────────────┘
```

**实现状态**: ✅ 已实现

---

### 3. 填写问卷
**页面**: `/nankai-questionnaire-fill?level=初级`

**功能**:
- 显示当前级别的所有题目
- 支持多种题型（单选、多选、填空）
- 实时保存草稿
- 进度显示
- 必填项验证

**题目示例**:
```
第1题：是否建立股东大会制度？（2分）
□ 是
□ 否
□ 部分完成
  详细说明：___________________

第2题：以下哪些制度已建立？（多选，每项1分）
□ 董事会制度
□ 监事会制度
□ 总经理制度
□ 财务管理制度
```

**实现状态**: ✅ 已实现

---

### 4. 评分计算
**触发时机**: 用户点击"提交问卷"按钮

**计算逻辑**:
```python
# 1. 读取评分规则（从indicator_management）
scoring_rules = get_scoring_rules(level)

# 2. 计算原始得分
total_score = 0
max_score = 0
for question in questions:
    rule = scoring_rules[question.id]
    score = calculate_score(question, rule, answer)
    total_score += score
    max_score += rule.max_score

# 3. 转换为百分制
percentage = (total_score / max_score) * 100

# 4. 判断是否合格
is_qualified = percentage >= 60
```

**评分类型**:
1. **二元评分**: 是=满分，否=0分
2. **全部必选**: 全选=满分，否则=0分
3. **多项评分**: 每项独立计分，累加
4. **负向评分**: 选中扣分
5. **分级评分**: 根据选项数量分级给分

**实现状态**: ✅ 已实现

---

### 5. 等级解锁机制
**规则**:
- 初级问卷：默认解锁，所有企业可填
- 中级问卷：初级得分≥60分才解锁
- 高级问卷：中级得分≥60分才解锁

**实现逻辑**:
```python
def check_level_unlock(enterprise_id):
    # 检查初级得分
    beginner_score = get_latest_score(enterprise_id, '初级')
    if beginner_score < 60:
        return ['初级']  # 只能填初级
    
    # 检查中级得分
    intermediate_score = get_latest_score(enterprise_id, '中级')
    if intermediate_score < 60:
        return ['初级', '中级']  # 可填初级和中级
    
    # 全部解锁
    return ['初级', '中级', '高级']
```

**实现状态**: ⚠️ 需要完善

---

### 6. 自评报告生成
**触发时机**: 问卷提交成功后自动触发

**生成步骤**:
```python
def generate_self_assessment_report(submission_data):
    # 1. 读取工商联提供的报告模板
    template = report_engine.get_active_template()
    
    # 2. 计算得分
    scores = calculate_scores(submission_data)
    
    # 3. 维度分析
    dimension_analysis = analyze_dimensions(scores)
    
    # 4. 生成改进建议
    suggestions = generate_suggestions(scores)
    
    # 5. 填充模板
    report = fill_template(
        template,
        enterprise_info=submission_data['enterprise_info'],
        scores=scores,
        analysis=dimension_analysis,
        suggestions=suggestions
    )
    
    # 6. 保存报告
    report_path = save_report(report, enterprise_name)
    
    return report_path
```

**报告内容**:
1. 封面（企业名称、日期）
2. 执行摘要（评价结论、总分、亮点、问题）
3. 企业概况
4. 评价结果（综合得分、评价等级）
5. 维度分析（各维度得分和分析）
6. 亮点与优势
7. 问题与不足
8. 改进建议
9. 附录（详细评分表）

**实现状态**: ✅ 已实现

---

### 7. 结果展示页面
**页面**: `/nankai-result?score=85&level=初级`

**显示内容**:
```
┌─────────────────────────────────────────┐
│         问卷提交成功！                   │
├─────────────────────────────────────────┤
│  您的得分：85分（满分100分）             │
│  评价等级：良好                          │
│                                          │
│  恭喜！您已解锁中级问卷                  │
│  [继续填写中级问卷]                      │
├─────────────────────────────────────────┤
│  自评报告：                              │
│  📄 企业自评报告.docx                    │
│  [下载报告]                              │
│                                          │
│  ✉️ 报告已发送至：example@company.com   │
│  请查收邮件                              │
└─────────────────────────────────────────┘
```

**实现状态**: ✅ 已实现

---

### 8. 邮件发送
**触发时机**: 报告生成完成后自动发送

**邮件内容**:
```
主题：【企业名称】企业现代制度自评报告

尊敬的【企业名称】：

您好！

感谢您完成企业现代制度评价问卷填写。

您的评价结果如下：
- 评价级别：初级
- 综合得分：85分（满分100分）
- 评价等级：良好

详细的自评报告请查看附件。

如有疑问，请联系我们。

此致
敬礼！

南开大学企业制度研究中心
2025年12月2日

附件：企业_自评报告_20251202.docx
```

**实现逻辑**:
```python
def send_report_email(enterprise_info, report_path, score):
    email = enterprise_info['contact_email']
    enterprise_name = enterprise_info['enterprise_name']
    
    # 异步发送
    thread = threading.Thread(
        target=notification_service.send_email,
        args=(email, enterprise_name, report_path, score)
    )
    thread.start()
```

**实现状态**: ✅ 已实现

---

## 🔧 技术实现要点

### 1. 等级解锁检查
**位置**: `app.py` 或 `survey_engine/services/`

```python
@app.route('/api/check-level-access')
def check_level_access():
    enterprise_id = session.get('enterprise_id')
    level = request.args.get('level')
    
    # 检查是否有权限填写该级别
    has_access = check_level_unlock(enterprise_id, level)
    
    return jsonify({
        'success': True,
        'has_access': has_access,
        'message': '您需要先完成初级问卷' if not has_access else ''
    })
```

### 2. 得分存储
**位置**: `storage/submissions/`

```json
{
  "enterprise_id": "ENT001",
  "level": "初级",
  "score": {
    "total_score": 85,
    "max_score": 100,
    "percentage": 85,
    "is_qualified": true
  },
  "submitted_at": "2025-12-02T10:00:00"
}
```

### 3. 报告模板管理
**位置**: `report_engine/templates/`

```
report_engine/templates/
├── base_template.docx          # 基础模板
├── executive_summary.docx      # 执行摘要模板
└── detailed_report.docx        # 详细报告模板
```

---

## 📊 数据流向

```
企业填写问卷
    ↓
提交数据 → storage/nankai_submissions/
    ↓
评分引擎 ← indicator_management/scoring_rules
    ↓
得分结果 → 判断是否解锁下一级
    ↓
报告生成器 ← report_engine/templates
    ↓
生成报告 → storage/nankai_reports/
    ↓
    ├→ 显示下载链接
    └→ 发送邮件
```

---

## ✅ 当前实现状态

### 已实现功能 ✅
- [x] 企业用户登录
- [x] 问卷填写页面
- [x] 评分计算引擎
- [x] 自评报告生成
- [x] 结果展示页面
- [x] 邮件自动发送

### 需要完善功能 ⚠️
- [ ] 等级解锁机制的前端展示
- [ ] 历史填报记录查询
- [ ] 报告下载权限控制
- [ ] 填报进度保存和恢复
- [ ] 不合格提示和改进建议

---

## 🎯 用户体验优化建议

### 1. 进度提示
```
当前进度：初级问卷 → 中级问卷 → 高级问卷
         [已完成]   [进行中]   [未解锁]
```

### 2. 得分可视化
```
您的得分：85分
━━━━━━━━━━━━━━━━━━━━ 85%
优秀(90+)  良好(80-89)  合格(60-79)  待改进(<60)
                 ↑ 您在这里
```

### 3. 即时反馈
- 提交后立即显示得分
- 报告生成进度条
- 邮件发送状态提示

---

## 📞 常见问题

**Q1: 如果初级不合格怎么办？**
A: 系统会提示不合格原因，企业可以重新填写初级问卷。

**Q2: 可以跳过中级直接填高级吗？**
A: 不可以，必须按顺序完成，且每级都要达到60分才能解锁下一级。

**Q3: 报告什么时候生成？**
A: 提交问卷后立即开始生成，通常10秒内完成。

**Q4: 邮件没收到怎么办？**
A: 检查垃圾邮件箱，或在结果页面直接下载报告。

---

**文档版本**: v1.0.0  
**创建时间**: 2025-12-02  
**状态**: 流程设计完成，大部分功能已实现