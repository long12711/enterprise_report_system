# 工商联用户管理系统设计方案

## 一、需求分析

### 1. 功能需求
对工商联用户的基本信息进行**增删改查**（CRUD），实现用户权限的分级管理。

### 2. 用户分类与权限
根据工商联的组织结构，分为三个层级：

| 层级 | 用户类型 | 权限范围 | 可见范围 |
|------|---------|--------|--------|
| 县市级 | 县市工商联管理员 | 管理本县市的工商联用户 | 仅看到本县市的管理员 |
| 省级 | 省级工商联管理员 | 管理本省的工商联用户 | 看到本省所有县市的管理员 |
| 全国 | 全联管理员 | 管理所有工商联用户 | 看到所有层级的管理员 |

---

## 二、工商联用户基本信息字段

### 核心字段
```
1. 用户ID (user_id)
2. 用户名 (username) - 唯一
3. 邮箱 (email) - 唯一
4. 密码 (password) - 加密存储
5. 真实姓名 (real_name)
6. 手机号 (phone)
7. 所属层级 (level)
   - county: 县市级
   - province: 省级
   - national: 全国(全联)
8. 所属地区 (region)
   - 县市级: 具体县市名称
   - 省级: 省份名称
   - 全联: 空或"全国"
9. 角色 (role)
   - admin: 管理员
   - reviewer: 审核员
   - operator: 操作员
10. 审核权限等级 (review_level)
    - beginner: 初级(市级)
    - intermediate: 中级(省级)
    - advanced: 高级(国家级)
11. 部门 (department)
12. 职位 (position)
13. 创建时间 (created_at)
14. 更新时间 (updated_at)
15. 状态 (status)
    - active: 激活
    - inactive: 停用
    - pending: 待审核
16. 备注 (remark)
```

---

## 三、数据库设计

### 用户表 (chamber_users)
```sql
CREATE TABLE chamber_users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  real_name VARCHAR(50),
  phone VARCHAR(20),
  level ENUM('county', 'province', 'national') NOT NULL,
  region VARCHAR(100),
  role ENUM('admin', 'reviewer', 'operator') DEFAULT 'operator',
  review_level ENUM('beginner', 'intermediate', 'advanced'),
  department VARCHAR(100),
  position VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  status ENUM('active', 'inactive', 'pending') DEFAULT 'pending',
  remark TEXT,
  created_by VARCHAR(36),
  INDEX idx_level_region (level, region),
  INDEX idx_username (username),
  INDEX idx_email (email),
  INDEX idx_status (status)
);
```

---

## 四、权限控制规则

### 4.1 查看权限
```
县市级管理员：
  ✓ 查看本县市的所有工商联用户
  ✗ 查看其他县市的用户
  ✗ 查看省级、全联用户

省级管理员：
  ✓ 查看本省所有县市的工商联用户
  ✓ 查看本省级用户
  ✗ 查看其他省份的用户
  ✗ 查看全联用户

全联管理员：
  ✓ 查看所有层级的工商联用户
  ✓ 查看所有地区的用户
```

### 4.2 编辑权限
```
县市级管理员：
  ✓ 编辑本县市的操作员、审核员
  ✗ 编辑本县市的管理员
  ✗ 编辑上级用户

省级管理员：
  ✓ 编辑本省的县市级用户
  ✓ 编辑本省级用户
  ✗ 编辑全联用户

全联管理员：
  ✓ 编辑所有用户
```

### 4.3 删除权限
```
县市级管理员：
  ✓ 删除本县市的操作员
  ✗ 删除审核员及以上

省级管理员：
  ✓ 删除本省的县市级操作员
  ✓ 删除本省级操作员
  ✗ 删除全联用户

全联管理员：
  ✓ 删除所有用户
```

---

## 五、API 接口设计

### 5.1 获取用户列表
```
GET /api/portal/chamber/users
Query Parameters:
  - level: 'county' | 'province' | 'national' (可选)
  - region: string (可选)
  - role: 'admin' | 'reviewer' | 'operator' (可选)
  - status: 'active' | 'inactive' | 'pending' (可选)
  - keyword: string (搜索用户名/邮箱/真实姓名)
  - page: number (默认1)
  - limit: number (默认20)

Response:
{
  "success": true,
  "data": {
    "total": 100,
    "page": 1,
    "limit": 20,
    "users": [
      {
        "id": "uuid",
        "username": "user1",
        "email": "user1@example.com",
        "real_name": "张三",
        "phone": "13800138000",
        "level": "county",
        "region": "北京市朝阳区",
        "role": "admin",
        "review_level": "beginner",
        "department": "市场部",
        "position": "经理",
        "created_at": "2024-01-01T00:00:00Z",
        "status": "active",
        "remark": ""
      }
    ]
  }
}
```

### 5.2 创建用户
```
POST /api/portal/chamber/users
Body:
{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "password123",
  "real_name": "李四",
  "phone": "13900139000",
  "level": "county",
  "region": "北京市朝阳区",
  "role": "operator",
  "review_level": "beginner",
  "department": "技术部",
  "position": "工程师",
  "remark": "新增用户"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "username": "newuser",
    "message": "用户创建成功"
  }
}
```

### 5.3 更新用户
```
PUT /api/portal/chamber/users/:id
Body:
{
  "email": "newemail@example.com",
  "real_name": "李四",
  "phone": "13900139000",
  "role": "reviewer",
  "review_level": "intermediate",
  "department": "市场部",
  "position": "总监",
  "status": "active",
  "remark": "更新备注"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "message": "用户更新成功"
  }
}
```

### 5.4 删除用户
```
DELETE /api/portal/chamber/users/:id

Response:
{
  "success": true,
  "message": "用户删除成功"
}
```

### 5.5 获取用户详情
```
GET /api/portal/chamber/users/:id

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "username": "user1",
    "email": "user1@example.com",
    "real_name": "张三",
    "phone": "13800138000",
    "level": "county",
    "region": "北京市朝阳区",
    "role": "admin",
    "review_level": "beginner",
    "department": "市场部",
    "position": "经理",
    "created_at": "2024-01-01T00:00:00Z",
    "status": "active",
    "remark": ""
  }
}
```

### 5.6 批量导入用户
```
POST /api/portal/chamber/users/import
Body: FormData
  - file: Excel文件

Response:
{
  "success": true,
  "data": {
    "total": 100,
    "success_count": 98,
    "failed_count": 2,
    "errors": [
      {
        "row": 5,
        "error": "邮箱已存在"
      }
    ]
  }
}
```

---

## 六、前端界面设计

### 6.1 用户列表页面
- 搜索框：按用户名、邮箱、真实姓名搜索
- 筛选条件：
  - 层级（县市/省级/全联）
  - 地区（根据当前用户权限显示）
  - 角色（管理员/审核员/操作员）
  - 状态（激活/停用/待审核）
- 操作按钮：
  - 新增用户
  - 编辑
  - 删除
  - 启用/停用
  - 导出
  - 导入

### 6.2 用户编辑表单
- 基本信息：用户名、邮箱、真实姓名、手机号
- 权限设置：层级、地区、角色、审核权限等级
- 部门信息：部门、职位
- 状态：激活/停用/待审核
- 备注

### 6.3 权限提示
- 根据当前用户权限动态显示可操作的用户列表
- 操作按钮根据权限灰显或隐藏

---

## 七、业务流程

### 7.1 新增用户流程
1. 管理员点击"新增用户"
2. 填写用户信息表单
3. 系统验证：
   - 用户名唯一性
   - 邮箱唯一性
   - 权限验证（不能创建高于自己权限的用户）
4. 创建成功，发送激活邮件
5. 用户激活后可登录

### 7.2 编辑用户流程
1. 管理员点击"编辑"
2. 弹出编辑表单，预填用户信息
3. 修改信息
4. 系统验证权限
5. 保存成功

### 7.3 删除用户流程
1. 管理员点击"删除"
2. 确认删除
3. 系统验证权限
4. 删除成功

---

## 八、安全考虑

1. **密码安全**
   - 使用 bcrypt 加密存储
   - 密码最少8位，包含大小写字母、数字、特殊字符
   - 支持密码重置

2. **权限验证**
   - 后端严格验证权限
   - 不能跨越权限层级操作用户
   - 操作日志记录

3. **数据保护**
   - 敏感信息加密存储
   - 支持数据导出加密
   - 定期备份

4. **审计日志**
   - 记录所有用户操作
   - 记录登录日志
   - 记录权限变更

---

## 九、实现优先级

### Phase 1（必须）
- [ ] 用户表设计
- [ ] 基本CRUD接口
- [ ] 权限验证逻辑
- [ ] 前端列表和编辑页面

### Phase 2（重要）
- [ ] 批量导入功能
- [ ] 权限日志
- [ ] 用户启用/停用
- [ ] 密码重置

### Phase 3（优化）
- [ ] 用户分组管理
- [ ] 权限模板
- [ ] 数据导出
- [ ] 高级搜索

---

## 十、测试用例

### 测试场景
1. 县市级管理员只能看到本县市用户
2. 省级管理员能看到本省所有用户
3. 全联管理员能看到所有用户
4. 不能创建高于自己权限的用户
5. 不能删除高于自己权限的用户
6. 邮箱和用户名唯一性验证
7. 密码加密存储验证
8. 权限变更日志记录


