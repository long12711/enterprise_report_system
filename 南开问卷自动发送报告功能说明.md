# 南开问卷自动发送报告功能说明

## 功能概述

在用户提交南开问卷后，系统自动生成自评报告（Word格式，包含执行摘要）并通过邮件发送给填报人。

## 功能流程

```
用户提交问卷
    ↓
保存提交数据（JSON）
    ↓
计算评分（使用南开评分引擎）
    ↓
返回提交成功响应
    ↓
【异步执行】
    ↓
生成自评报告（Word，8章节）
    ├─ 封面
    ├─ 执行摘要（新增）
    ├─ 企业基本信息
    ├─ 评价概览
    ├─ 维度分析
    ├─ 优势与不足
    ├─ 改进建议
    └─ 附录：详细数据
    ↓
发送邮件（附件）
    ↓
完成
```

## 技术实现

### 1. 提交API更新

**文件**: [`app.py`](app.py:1002)  
**路由**: `/api/nankai/submit`  
**方法**: POST

**主要修改**：
```python
# 在提交成功后启动异步任务
thread = threading.Thread(
    target=generate_and_send_nankai_report_async,
    args=(submission_file, enterprise_info, level)
)
thread.start()
```

**返回信息**：
```json
{
    "success": true,
    "score": 82.5,
    "total_score": 82.5,
    "max_score": 100.0,
    "message": "问卷提交成功，自评报告将通过邮件发送",
    "submission_id": "企业名称_20251201_235959",
    "submission_file": "storage/nankai_submissions/submission_企业名称_20251201_235959.json"
}
```

### 2. 异步报告生成和发送函数

**函数**: [`generate_and_send_nankai_report_async()`](app.py:1156)

**功能**：
1. 读取企业信息（企业名称、联系人、邮箱）
2. 调用南开报告生成器生成Word报告
3. 通过邮件服务发送报告（作为附件）
4. 记录日志

**代码示例**：
```python
def generate_and_send_nankai_report_async(submission_file, enterprise_info, level):
    """异步生成南开问卷自评报告并发送邮件"""
    with app.app_context():
        try:
            enterprise_name = enterprise_info.get('enterprise_name', '企业')
            email = enterprise_info.get('contact_email', '')
            contact_name = enterprise_info.get('contact_person', '')
            
            # 生成自评报告
            if nankai_report_generator:
                report_path = nankai_report_generator.generate_report(submission_file)
                
                # 发送邮件
                if email:
                    email_sent = notification_service.send_email(
                        to_email=email,
                        enterprise_name=enterprise_name,
                        contact_name=contact_name,
                        report_url='',
                        attachment_path=report_path
                    )
```

### 3. 邮件服务

**文件**: [`notification_service.py`](notification_service.py:1)  
**类**: `NotificationService`

**邮件内容**：
- 主题：`{企业名称} - 现代企业制度评价自评报告`
- 正文：HTML格式，包含企业信息、报告说明、温馨提示
- 附件：自评报告Word文档

**邮件模板特点**：
- 专业的HTML设计
- 渐变色标题
- 清晰的内容结构
- 友好的提示信息

### 4. 报告生成器

**文件**: [`nankai_report_generator.py`](nankai_report_generator.py:1)  
**类**: `NankaiReportGenerator`

**报告结构**（8章节）：
1. **封面页** - 企业名称、评价级别、综合得分、生成日期
2. **执行摘要** - 评价结论、总得分、企业概况、评价亮点、存在问题
3. **企业基本信息** - 表格形式展示企业信息
4. **评价概览** - 得分情况、评价等级、总体评价
5. **维度分析** - 各一级指标详细分析
6. **优势与不足** - 主要优势和需要改进的方面
7. **改进建议** - 短期、中长期、持续改进建议
8. **附录：详细数据** - 完整的问卷答题记录

## 使用流程

### 用户端操作

1. **访问问卷页面**
   ```
   http://localhost:5000/nankai-questionnaire-fill?level=初级
   ```

2. **填写企业信息**
   - 企业名称（必填）
   - 联系人（必填）
   - 联系电话（必填）
   - **联系邮箱（必填）** ⭐ 用于接收报告
   - 主营业务
   - 企业规模

3. **填写问卷**
   - 根据实际情况选择选项
   - 可上传佐证材料
   - 部分完成的题目可填写详细说明

4. **提交问卷**
   - 点击"提交问卷"按钮
   - 系统显示提交成功和得分
   - 提示"自评报告将通过邮件发送"

5. **接收报告**
   - 查收邮箱（通常几分钟内到达）
   - 下载附件中的Word报告
   - 查看详细的评价结果和建议

### 系统端日志

```
[INFO] 开始为 今麦郎食品有限公司 生成南开自评报告...
[OK] 南开自评报告已生成: storage/nankai_reports/自评报告_今麦郎食品有限公司_20251201_235959.docx
[INFO] 正在发送邮件到 contact@jinmailang.com...
[SUCCESS] 南开自评报告邮件发送成功到 contact@jinmailang.com
```

## 配置要求

### 1. 邮件服务配置

**文件**: `config.json`

```json
{
  "email": {
    "smtp_server": "smtp.example.com",
    "smtp_port": 587,
    "username": "your_email@example.com",
    "password": "your_password",
    "from_name": "企业评价系统",
    "use_tls": true
  }
}
```

**常用邮箱配置**：

**QQ邮箱**：
```json
{
  "smtp_server": "smtp.qq.com",
  "smtp_port": 587,
  "username": "your_qq@qq.com",
  "password": "授权码（非QQ密码）",
  "use_tls": true
}
```

**163邮箱**：
```json
{
  "smtp_server": "smtp.163.com",
  "smtp_port": 465,
  "username": "your_email@163.com",
  "password": "授权码",
  "use_tls": false
}
```

**Gmail**：
```json
{
  "smtp_server": "smtp.gmail.com",
  "smtp_port": 587,
  "username": "your_email@gmail.com",
  "password": "应用专用密码",
  "use_tls": true
}
```

### 2. 指标文件

确保存在以下文件之一：
- `nankai_indicators.xlsx`（推荐）
- `测试问卷.xlsx`
- `指标体系.xlsx`

### 3. 存储目录

系统自动创建以下目录：
- `storage/nankai_submissions/` - 问卷提交数据
- `storage/nankai_reports/` - 生成的自评报告
- `storage/nankai_downloads/` - Excel下载文件

## 功能特点

### ✨ 自动化
- 提交后自动生成报告
- 自动发送邮件
- 无需人工干预

### ✨ 异步处理
- 不阻塞用户操作
- 后台生成报告
- 提高系统响应速度

### ✨ 专业报告
- 8章节完整结构
- 执行摘要快速了解
- 详细的分析和建议
- 专业的Word格式

### ✨ 邮件通知
- HTML格式邮件
- 报告作为附件
- 清晰的说明信息
- 友好的用户体验

### ✨ 可靠性
- 异常处理机制
- 详细的日志记录
- 失败不影响提交
- 可手动重新发送

## 故障排查

### 1. 邮件未收到

**可能原因**：
- 邮箱地址填写错误
- 邮件服务配置错误
- 邮件被拦截（垃圾邮件）
- 网络问题

**解决方法**：
1. 检查邮箱地址是否正确
2. 查看系统日志确认发送状态
3. 检查垃圾邮件箱
4. 验证邮件服务配置
5. 使用手动下载功能

### 2. 报告生成失败

**可能原因**：
- 指标文件不存在
- 数据格式错误
- 权限问题

**解决方法**：
1. 检查指标文件是否存在
2. 查看系统日志错误信息
3. 确认存储目录权限
4. 联系系统管理员

### 3. 邮件发送失败

**可能原因**：
- SMTP配置错误
- 授权码错误
- 网络连接问题

**解决方法**：
1. 验证SMTP配置
2. 重新获取授权码
3. 测试网络连接
4. 查看详细错误日志

## 手动操作

如果自动发送失败，可以手动操作：

### 1. 手动生成报告

访问API：
```
GET /api/nankai/generate-report/{submission_id}
```

### 2. 手动下载报告

访问API：
```
GET /api/nankai/download-report/{filename}
```

### 3. 管理员重新发送

管理员可以在后台重新发送邮件。

## 测试建议

### 1. 测试邮件配置

```bash
# 使用测试邮件API
POST /test_email
{
  "email": "test@example.com"
}
```

### 2. 测试完整流程

1. 填写测试问卷
2. 使用真实邮箱地址
3. 提交问卷
4. 查看系统日志
5. 检查邮箱

### 3. 验证报告内容

1. 打开Word报告
2. 检查8个章节是否完整
3. 验证执行摘要内容
4. 确认数据准确性

## 更新日志

- **2024-12-01 v2.0**: 自动发送报告功能
  - 提交后自动生成报告
  - 自动发送邮件通知
  - 异步处理提高性能
  - 集成执行摘要功能

- **2024-12-01 v1.0**: 基础报告生成
  - 手动生成报告
  - 手动下载报告

---

**文档版本**: v2.0  
**更新日期**: 2024-12-01  
**维护者**: 系统开发团队