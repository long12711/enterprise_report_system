# 问卷生成器 V3 更新说明

## 更新时间
2025-12-01

## 更新背景

根据用户反馈"根据评分规则来修改一下我的调查问卷"，我们对问卷生成器进行了重大升级，使其能够根据南开大学的详细评分准则自动生成精确的问卷选项。

## 主要改进

### 1. 基于评分准则的选项生成

**之前的问题：**
- 问卷选项是基于简单的"打分标准"字段生成的
- 选项与实际评分规则不完全对应
- 无法准确反映评分准则的复杂性

**现在的解决方案：**
- 直接解析"评分准则"列的详细文本
- 根据评分类型自动生成对应的选项
- 选项与评分规则完全一致

### 2. 支持5种评分类型

#### 类型1：二元评分（Binary）
- **特征**：是/否问题
- **示例选项**：
  - A. 是（已建立/制定/设立）
  - B. 否（未建立/制定/设立）

#### 类型2：全部完成型（All Required）
- **特征**：必须全部完成才得分
- **示例选项**：
  - A. 全部完成
  - B. 部分完成
  - C. 均未完成

#### 类型3：多项累计（Multi-item）
- **特征**：根据完成项数分段给分
- **示例选项**：
  - A. 完成3项及以上
  - B. 完成1-2项
  - C. 均未完成

#### 类型4：否决性指标（Negative）
- **特征**：存在违规则扣分
- **示例选项**：
  - A. 是（存在违规情况）
  - B. 否（不存在违规情况）

#### 类型5：分级评分（Graded）
- **特征**：根据完成程度分级
- **示例选项**：
  - A. 完全达到要求
  - B. 基本达到要求
  - C. 部分达到要求
  - D. 未达到要求

### 3. 智能规则识别

系统能够自动识别评分准则的类型：

```python
def _identify_rule_type(self, rule_text: str, score_value: str) -> str:
    """
    识别评分规则类型
    
    识别逻辑：
    1. 检查分值是否为负数 → 否决性指标
    2. 检查是否包含"全部完成"或"部分完成不得分" → 全部完成型
    3. 检查是否包含"X项"且有"得分"描述 → 多项累计
    4. 检查分值范围（如0-2）且范围>1 → 分级评分
    5. 默认 → 二元评分
    """
```

### 4. 精确的选项提取

对于多项累计类型，系统能够从评分准则中提取具体的项数要求：

**示例1：**
- 评分准则："实现'1-2项'的得1分，实现'3项'的得2分"
- 生成选项：
  - A. 完成3项
  - B. 完成1-2项
  - C. 均未完成

**示例2：**
- 评分准则："完成3项及以上得2分"
- 生成选项：
  - A. 完成3项及以上
  - B. 完成1-2项
  - C. 均未完成

### 5. 增强的问卷格式

#### 新增列：
- **评分准则列**：显示完整的评分规则文本
- **分值列**：显示该指标的分值（如1分、0-2分、-10分）
- **评分类型标注**：在补充说明中标注评分类型（二元/多项/全部/否决/分级）

#### 改进的表格样式：
- 表头使用蓝色背景（#4472C4）
- 表头文字白色加粗
- 一级指标标题使用深蓝色（RGB 0,51,102）
- 更清晰的视觉层次

### 6. 完整的数据提示

系统会自动从评分准则中提取需要填写的数据项：

- 人数：______人
- 次数：______次
- 金额：______万元
- 比例：______%
- 数量：______个

## 文件对比

### 旧版本（nankai_questionnaire_generator.py）
- 基于"打分标准"字段
- 简单的选项映射
- 不考虑评分准则的复杂性

### 新版本（nankai_questionnaire_generator_v3.py）
- 基于"评分准则"字段
- 智能识别评分类型
- 精确生成对应选项
- 完整显示评分信息

## 生成的文件

运行 `python survey_generator/nankai_questionnaire_generator_v3.py` 会生成：

```
survey_generator/output/questionnaires/
├── 调查问卷_初级_V3_20251201_233858.docx  (64个指标)
├── 调查问卷_中级_V3_20251201_233858.docx  (52个指标)
└── 调查问卷_高级_V3_20251201_233858.docx  (42个指标)
```

## 与评分系统的配合

新版问卷生成器与 `nankai_scoring_engine.py` 完美配合：

1. **问卷生成器**：根据评分准则生成精确的选项
2. **评分引擎**：根据评分准则计算精确的得分
3. **一致性保证**：两者使用相同的规则识别逻辑

## 使用方法

### 方法1：直接运行脚本
```bash
python survey_generator/nankai_questionnaire_generator_v3.py
```

### 方法2：在代码中使用
```python
from survey_generator.nankai_questionnaire_generator_v3 import NankaiQuestionnaireGeneratorV3

# 创建生成器
generator = NankaiQuestionnaireGeneratorV3(
    "survey_generator/南开大学-现代企业制度指数评价体系初稿2025.10.22（单独指标）(1).xlsx"
)

# 生成所有级别的问卷
results = generator.generate_all_questionnaires()

# 或生成单个级别
path = generator.generate_questionnaire("初级")
```

## 技术特点

### 1. 正则表达式解析
使用正则表达式从评分准则文本中提取关键信息：
- 项数要求：`r'完成\s*[【\[]?(\d+)[】\]]?\s*项'`
- 范围描述：`r'(\d+)-(\d+)\s*项'`
- 及以上：`r'(\d+)\s*项及以上'`

### 2. 智能默认值
当无法精确解析时，提供合理的默认选项

### 3. 错误处理
- 优雅处理缺失的评分准则
- 提供清晰的错误信息
- 不影响其他指标的生成

## 测试结果

✅ 成功加载指标数据：初级 64 条，中级 52 条，高级 42 条
✅ 成功生成初级问卷
✅ 成功生成中级问卷
✅ 成功生成高级问卷

## 下一步计划

1. ✅ 问卷生成器已根据评分规则更新
2. ✅ 评分引擎已实现精确计算
3. ⏳ 更新Web界面以使用新的问卷格式
4. ⏳ 测试完整的提交-评分-报告流程

## 总结

V3版本的问卷生成器实现了从"简单映射"到"智能解析"的重大升级，确保问卷选项与南开大学的评分准则完全一致，为后续的精确评分奠定了基础。

---

**版本**: V3.0
**创建时间**: 2025-12-01
**作者**: Kilo Code