<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¼ä¸šé—¨æˆ·</title>
  <style>
    :root{--brand:#4338ca;--bg:#f5f7fa;--card:#fff;--text:#111;--muted:#666}
    body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#101827;color:#e5e7eb;display:flex;flex-direction:column}
    .side-header{padding:18px 16px;font-weight:700;border-bottom:1px solid #1f2937}
    .menu button{width:100%;text-align:left;background:transparent;border:none;color:#cbd5e1;padding:12px 16px;cursor:pointer;border-left:3px solid transparent}
    .menu button:hover{background:#0b1220}
    .menu button.active{color:#fff;background:#0b1220;border-left-color:#60a5fa}
    .content{flex:1;padding:22px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px;margin-bottom:16px}
    h1{margin:0 0 8px;color:var(--brand)}
    h2{margin:0 0 10px}
    .btn{display:inline-block;padding:8px 14px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
    .btn.gray{background:#6b7280}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    textarea{min-height:90px;width:100%}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
    .tag.pending{background:#d97706}
    .tag.approved{background:#16a34a}
    .tag.rejected{background:#ef4444}
    @media (max-width: 900px){.layout{flex-direction:column}.sidebar{width:100%;flex-direction:row;overflow-x:auto}.menu{display:flex}.menu button{white-space:nowrap}}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-header">ä¼ä¸šé—¨æˆ·</div>
      <div class="menu">
        <button class="active" data-tab="home">æ¦‚è§ˆ</button>
        <button data-tab="history">å†å²é—®å·</button>
        <button data-tab="growth">æˆé•¿è½¨è¿¹</button>
        <button data-tab="preference">ä¼ä¸šåå‘</button>
        <button data-tab="special">ä¸“é¡¹ç”³è¯·</button>
        <button data-tab="experts">åŒ¹é…ä¸“å®¶</button>
      </div>
    </aside>
    <main class="content">
      <!-- æ¦‚è§ˆ -->
      <section id="tab-home" class="tab card">
        <h1>æ¬¢è¿ä½¿ç”¨ç°ä»£ä¼ä¸šåˆ¶åº¦æŒ‡æ•°è¯„ä»·ç³»ç»Ÿ</h1>
        <div class="muted" id="welcomeInfo">åŠ è½½ä¸­...</div>
        <div style="margin-top:12px;">
          <button class="btn" id="startBtn">å¼€å§‹å¡«å†™é—®å·</button>
          <button class="btn gray" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
      </section>

      <!-- å†å²é—®å· -->
      <section id="tab-history" class="tab card" style="display:none">
        <h2>å†å²é—®å·è®°å½•</h2>
        <table class="table" id="tblHistory">
          <thead><tr><th>æäº¤æ—¶é—´</th><th>åˆ†æ•°</th><th>æŸ¥çœ‹è¯•å·</th><th>è°ƒæŸ¥æŠ¥å‘Š</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- æˆé•¿è½¨è¿¹ -->
      <section id="tab-growth" class="tab card" style="display:none">
        <h2>æˆé•¿è½¨è¿¹</h2>
        <div class="muted">æœ€è¿‘Næ¬¡è¯„ä¼°å¾—åˆ†è¶‹åŠ¿ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰</div>
        <table class="table" id="tblGrowth"><thead><tr><th>#</th><th>æ—¶é—´</th><th>çº§åˆ«</th><th>å¾—åˆ†ç‡</th></tr></thead><tbody></tbody></table>
      </section>

      <!-- ä¼ä¸šåå‘ -->
      <section id="tab-preference" class="tab card" style="display:none">
        <h2>ä¼ä¸šåå‘ï¼ˆç»´åº¦è¡¨ç°ï¼‰</h2>
        <div class="muted">ç»Ÿè®¡æœ€åä¸€æ¬¡é—®å·ä¸­å„ä¸€çº§æŒ‡æ ‡çš„å¾—åˆ†ç‡ï¼ˆä»…ä¾›å‚è€ƒï¼‰</div>
        <table class="table" id="tblPref"><thead><tr><th>ä¸€çº§æŒ‡æ ‡</th><th>å¾—åˆ†ç‡</th></tr></thead><tbody></tbody></table>
      </section>

      <!-- ä¸“é¡¹ç”³è¯·ï¼ˆå·²ç§»å…¥å·¦ä¾§èœå•ï¼‰ -->
      <section id="tab-special" class="tab card" style="display:none">
        <h2>ğŸ“Œ ä¸“é¡¹ç”³è¯·</h2>
        <div class="muted">æäº¤ä¸å½“å‰ä¼ä¸šçº§åˆ«å¯¹åº”çš„ä¸“é¡¹ææ–™ï¼Œäº¤ç”±ç›¸åº”çº§åˆ«çš„å·¥å•†è”ç”¨æˆ·è¿›è¡Œå®¡æ ¸ã€‚</div>
        <div class="row" style="margin-top:12px;">
          <div style="flex:1 1 320px;min-width:320px;">
            <label>ç”³è¯·æ ‡é¢˜</label>
            <input id="spTitle" type="text" placeholder="å¦‚ï¼šæ•°å­—åŒ–è½¬å‹æ ‡æ†ç”³è¯·" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div style="flex:1 1 100%;">
            <label>ç”³è¯·è¯´æ˜</label>
            <textarea id="spDesc" placeholder="ç®€è¦è¯´æ˜ç”³è¯·äº‹ç”±ã€äº®ç‚¹ä¸ä½è¯è¦ç‚¹"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div style="flex:1 1 100%;">
            <label>ä¸Šä¼ é™„ä»¶ï¼ˆå¯å¤šé€‰ï¼Œæ”¯æŒdocxã€pdfã€xlsxã€zipã€jpgã€pngç­‰ï¼‰</label>
            <input id="spFiles" class="files" type="file" multiple />
          </div>
        </div>
        <div style="margin-top:12px;">
          <button class="btn" onclick="submitSpecial()" id="spBtn">æäº¤ä¸“é¡¹ç”³è¯·</button>
          <span id="spStatus" style="margin-left:10px;color:#555;"></span>
        </div>

        <h3 style="margin-top:18px;">æˆ‘çš„ä¸“é¡¹ç”³è¯·</h3>
        <table class="table" id="spTable">
          <thead>
            <tr>
              <th>ç”³è¯·ID</th>
              <th>æ ‡é¢˜</th>
              <th>æäº¤æ—¶é—´</th>
              <th>å®¡æ ¸çº§åˆ«</th>
              <th>çŠ¶æ€</th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- åŒ¹é…ä¸“å®¶ -->
      <section id="tab-experts" class="tab card" style="display:none">
        <h2>åŒ¹é…ä¸“å®¶</h2>
        <div class="muted">ç³»ç»ŸæŒ‰æ‚¨çš„å½“å‰ç­‰çº§åŒ¹é…ç›¸åº”ç­‰çº§ä¸“å®¶ï¼Œå¯åœ¨æ­¤å¤„å‘èµ·æ²Ÿé€šã€‚</div>
        <div class="grid-2">
          <div>
            <table class="table" id="tblExperts"><thead><tr><th>ä¸“å®¶è´¦å·</th><th>ç§°è°“</th><th>ç­‰çº§</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <h3>ä¸ä¸“å®¶æ²Ÿé€š</h3>
            <div class="row"><select id="expertSelect"></select></div>
            <div class="row"><textarea id="expertMsg" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..."></textarea></div>
            <div class="row"><button class="btn" onclick="sendMsg()">å‘é€</button></div>
            <div id="chatLog" class="muted" style="margin-top:10px;white-space:pre-wrap"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const tabs = document.querySelectorAll('.menu button');
    tabs.forEach(btn=>btn.onclick=()=>switchTab(btn.dataset.tab, btn));
    function switchTab(id, btn){
      document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(sec=>sec.style.display='none');
      const s = document.getElementById('tab-'+id); if(s) s.style.display='block';
      if(id==='history') loadHistory();
      if(id==='growth') loadGrowth();
      if(id==='preference') loadPreference();
      if(id==='experts') loadExperts();
      if(id==='special') loadMySpecials();
    }

    async function logout(){ await fetch('/api/logout',{method:'POST'}); location.href='/'; }

    // åˆå§‹åŒ–æ¬¢è¿ä¸é—®å·æŒ‰é’®
    (async function(){
      try{
        const res = await fetch('/api/session');
        const s = await res.json();
        const level = s.user_level || 'advanced';
        document.getElementById('startBtn').onclick = ()=>{ location.href = `/questionnaire?user_type=enterprise&user_level=${level}`; };
        document.getElementById('welcomeInfo').textContent = `å½“å‰è´¦å·ï¼š${s.display_name||s.username||''} | ç­‰çº§ï¼š${level}`;
      }catch(e){
        document.getElementById('startBtn').onclick = ()=>{ location.href='/questionnaire'; };
      }
      // é»˜è®¤è¿›æ¥æ˜¾ç¤ºæ¦‚è§ˆï¼Œä¸åšå…¶ä»–åŠ è½½ï¼Œåˆ‡æ¢tabæ—¶å†æŒ‰éœ€åŠ è½½
    })();

    // å†å²é—®å·
    async function loadHistory(){
      const res = await fetch('/api/enterprise/history'); const data = await res.json();
      const tb = document.querySelector('#tblHistory tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan="4">${data.error||'åŠ è½½å¤±è´¥'}</td></tr>`; return; }
      if(data.items.length === 0) {
        tb.innerHTML = `<tr><td colspan="4">æš‚æ— å†å²è®°å½•</td></tr>`; return;
      }
      data.items.forEach(it=>{
        const scoreText = it.score ? `${it.score.total.toFixed(1)} / ${it.score.max.toFixed(1)}` : 'N/A';
        const questionnaireLink = `<a href="/download/submission/${encodeURIComponent(it.excel_file)}" class="btn" style="padding: 4px 8px; font-size: 12px;" target="_blank">æŸ¥çœ‹è¯¦æƒ…</a>`;
        const reportLink = it.report_file ? `<a href="/download/${encodeURIComponent(it.report_file)}" class="btn gray" style="padding: 4px 8px; font-size: 12px;" target="_blank">ä¸‹è½½æŠ¥å‘Š</a>` : '<span>æš‚æ— </span>';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.time_text}</td>
          <td>${scoreText}</td>
          <td>${questionnaireLink}</td>
          <td>${reportLink}</td>
        `;
        tb.appendChild(tr);
      })
    }

    // æˆé•¿è½¨è¿¹ï¼ˆè¡¨æ ¼ç®€ç‰ˆï¼‰
    async function loadGrowth(){
      const res = await fetch('/api/enterprise/scores'); const data = await res.json();
      const tb = document.querySelector('#tblGrowth tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan=4>${data.error||'åŠ è½½å¤±è´¥'}</td></tr>`; return; }
      data.items.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${it.time_text}</td><td>${it.user_level}</td><td>${it.percentage.toFixed(1)}%</td>`;
        tb.appendChild(tr);
      })
    }

    // ä¼ä¸šåå‘ï¼ˆå„ä¸€çº§æŒ‡æ ‡å¾—åˆ†ç‡ï¼‰
    async function loadPreference(){
      const res = await fetch('/api/enterprise/preference'); const data = await res.json();
      const tb = document.querySelector('#tblPref tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan=2>${data.error||'åŠ è½½å¤±è´¥'}</td></tr>`; return; }
      data.items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${it.level1}</td><td>${it.percentage.toFixed(1)}%</td>`;
        tb.appendChild(tr);
      })
    }

    // ä¸“é¡¹ç”³è¯·ï¼šæäº¤ä¸åˆ—è¡¨
    async function submitSpecial(){
      const title = document.getElementById('spTitle').value.trim();
      const desc = document.getElementById('spDesc').value.trim();
      const files = document.getElementById('spFiles').files;
      const status = document.getElementById('spStatus');
      const btn = document.getElementById('spBtn');
      if(!title){ status.textContent='è¯·å¡«å†™æ ‡é¢˜'; return; }
      const fd = new FormData(); fd.append('title', title); fd.append('desc', desc);
      for(let i=0;i<files.length;i++){ fd.append('files', files[i]); }
      btn.disabled=true; status.textContent='æäº¤ä¸­...';
      try{
        const res = await fetch('/api/special/apply', { method:'POST', body: fd });
        const data = await res.json();
        if(res.ok && data.success){
          status.textContent='æäº¤æˆåŠŸ';
          document.getElementById('spTitle').value='';
          document.getElementById('spDesc').value='';
          document.getElementById('spFiles').value='';
          await loadMySpecials();
        }else{
          status.textContent='æäº¤å¤±è´¥ï¼š'+(data.error||'');
        }
      }catch(e){ status.textContent='æäº¤å¤±è´¥ï¼š'+e.message; }
      finally{ btn.disabled=false; }
    }

    async function loadMySpecials(){
      try{
        const res = await fetch('/api/special/my'); const data = await res.json();
        const tb = document.querySelector('#spTable tbody'); tb.innerHTML='';
        if(!data.success){ tb.innerHTML = `<tr><td colspan=6>${data.error||'åŠ è½½å¤±è´¥'}</td></tr>`; return; }
        data.items.forEach(it=>{
          const tr=document.createElement('tr');
          const statusTag = it.status==='approved' ? '<span class="tag approved">å·²é€šè¿‡</span>' : (it.status==='rejected' ? '<span class="tag rejected">å·²é©³å›</span>' : '<span class="tag pending">å¾…å®¡æ ¸</span>');
          tr.innerHTML = `<td>${it.id}</td><td>${it.title||''}</td><td>${it.time_text||''}</td><td>${it.level||''}</td><td>${statusTag}</td><td>${it.remark||''}</td>`;
          tb.appendChild(tr);
        })
      }catch(e){ console.error(e); }
    }

    // åŒ¹é…ä¸“å®¶
    async function loadExperts(){
      const res = await fetch('/api/enterprise/match-experts'); const data = await res.json();
      const tb = document.querySelector('#tblExperts tbody'); tb.innerHTML='';
      const sel = document.getElementById('expertSelect'); sel.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan=4>${data.error||'åŠ è½½å¤±è´¥'}</td></tr>`; return; }
      data.items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${it.username}</td><td>${it.display_name||''}</td><td>${it.level}</td><td><button class='btn' onclick="chooseExpert('${it.username}')">é€‰æ‹©</button></td>`;
        tb.appendChild(tr);
        const o=document.createElement('option'); o.value=it.username; o.textContent=`${it.display_name||it.username} (${it.level})`; sel.appendChild(o);
      })
      if(data.items[0]) chooseExpert(data.items[0].username);
    }
    function chooseExpert(u){ document.getElementById('expertSelect').value=u; loadChat(); }
    async function sendMsg(){
      const expert = document.getElementById('expertSelect').value;
      const msg = document.getElementById('expertMsg').value.trim(); if(!msg) return;
      await fetch('/api/enterprise/contact-expert',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({expert_username:expert,message:msg})});
      document.getElementById('expertMsg').value='';
      loadChat();
    }
    async function loadChat(){
      const expert = document.getElementById('expertSelect').value;
      const res = await fetch(`/api/enterprise/contact-expert?expert_username=${encodeURIComponent(expert)}`);
      const data = await res.json();
      const log = document.getElementById('chatLog');
      if(!data.success){ log.textContent = data.error || 'æš‚æ— ä¼šè¯'; return; }
      log.textContent = (data.items||[]).map(i=>`[${i.time_text}] ${i.from}: ${i.message}`).join('\n');
    }
  </script>
</body>
</html>
