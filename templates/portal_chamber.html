<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工商联门户</title>  
  <style>
    :root{--brand:#4338ca;--bg:#f5f7fa;--card:#fff;--text:#111;--muted:#666}
    body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#101827;color:#e5e7eb;display:flex;flex-direction:column;position:relative;z-index:20}
    .side-header{padding:18px 16px;font-weight:700;border-bottom:1px solid #1f2937}
    .menu{flex:1;overflow-y:auto;overflow-x:visible}
    .menu-group{padding:8px 0}
    .menu-group-title{padding:12px 16px;font-size:12px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px}
    .menu .menu-item{position:relative}
    .menu .menu-btn{width:100%;text-align:left;background:transparent;border:none;color:#cbd5e1;padding:12px 16px;cursor:pointer;border-left:3px solid transparent;display:flex;align-items:center;justify-content:space-between;font-size:14px}
    .menu .menu-btn:hover{background:#0b1220}
    .menu .menu-item.active .menu-btn{color:#fff;background:#0b1220;border-left-color:#60a5fa}
    .menu-arrow{font-size:12px;margin-left:8px;transition:transform .15s ease}
    .menu .menu-item.open .menu-btn .menu-arrow{transform:rotate(90deg)}
    .submenu-tooltip{display:none;position:fixed;left:0;top:0;background:#1f2937;border:1px solid #374151;border-radius:8px;min-width:160px;max-width:280px;box-shadow:0 10px 25px rgba(0,0,0,0.3);z-index:9999;padding:8px 0;pointer-events:auto;word-wrap:break-word;white-space:normal;box-sizing:border-box;overflow:hidden}
    /* JS 控制显示/隐藏和定位，无需 :hover 触发 */
    .submenu-item{padding:10px 16px;color:#cbd5e1;font-size:13px;cursor:pointer;display:block;width:100%;text-align:left;background:transparent;border:none;word-break:break-word;white-space:normal;line-height:1.4}
    .submenu-item:hover{background:#374151;color:#fff}
    /* 让鼠标移入子菜单时保持显示，避免跨越缝隙时消失 */
    .submenu-tooltip:hover{display:block !important}
    /* 兜底：点击箭头展开为内嵌模式（移动端/部分浏览器 hover 失效时） */
    .menu .menu-item.open > .submenu-tooltip{display:block !important;position:static !important;left:auto !important;top:auto !important;margin:6px 0 8px;background:#0b1220;border-color:#2b3445;width:100%;min-width:0;box-shadow:none}
    .content{flex:1;padding:22px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px;margin-bottom:16px}
    h1,h2{margin:0 0 10px}
    .btn{display:inline-block;padding:8px 14px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
    .btn.gray{background:#6b7280}
    .table{width:100%;border-collapse:collapse;margin-top:15px}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
    .table th{background:#f9fafb;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:15px}
    .toolbar select{padding:7px 10px;border:1px solid #ddd;border-radius:8px}
    .tag{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;color:#fff}
    .tag.ok{background:#16a34a}
    .tag.warn{background:#d97706}
    .tag.no{background:#ef4444}
    .btn.ok{background:#16a34a}
    .btn.no{background:#ef4444}
    .btn.dl{background:#0ea5e9}
    .remark{width:220px;padding:6px;border:1px solid #ddd;border-radius:8px}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="side-header">工商联门户</div>
      <div class="menu">
        <!-- 企业管理 -->
        <div class="menu-item active" data-key="enterprise">
          <button class="menu-btn" type="button">
            <span>企业管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('enterprise-info');">企业信息</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('upgrade-center');">评价升级</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-match');">专家匹配管理</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('enterprise-history');">企业自评详情</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('tutoring-ledger');">专家辅导台账</div>
          </div>
        </div>

        <!-- 专家管理 -->
        <div class="menu-item" data-key="expert">
          <button class="menu-btn" type="button">
            <span>专家管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('experts-info');">专家信息</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-self');">专家自评详情</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-rate');">专家评级管理</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-tutoring');">专家辅导详情</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-evaluations');">企业评价详情</div>
          </div>
        </div>

        <!-- 工商联用户管理 -->
        <div class="menu-item" data-key="chamber">
          <button class="menu-btn" type="button">
            <span>工商联用户管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('chamber-users');">用户管理</div>
          </div>
        </div>

        <!-- 专项反馈管理 -->
        <div class="menu-item" data-key="special">
          <button class="menu-btn" type="button">
            <span>专项反馈管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('special-list');">反馈列表</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('special-analysis');">深度分析</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('special-report');">分析报告</div>
          </div>
        </div>

        <!-- 基础问卷管理 -->
        <div class="menu-item" data-key="questionnaire">
          <button class="menu-btn" type="button">
            <span>基础问卷管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('indicators');">指标体系</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('scoring-rules');">评分规则</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('enterprise-surveys');">企业问卷</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('expert-surveys');">专家问卷</div>
          </div>
        </div>

        <!-- 平台基础功能管理 -->
        <div class="menu-item" data-key="platform">
          <button class="menu-btn" type="button">
            <span>平台基础功能管理</span>
            <span class="menu-arrow">→</span>
          </button>
          <div class="submenu-tooltip">
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('roles');">角色管理</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('menus');">菜单管理</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('permissions');">权限管理</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('email-config');">邮箱配置</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('sms-gateway');">短信网关</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('reports');">查看企业报告</div>
            <div class="submenu-item" onclick="event.stopPropagation(); switchTab('send-report');">发送报告</div>
          </div>
        </div>
      </div>
    </aside>
    <main class="content">
        <button class="btn gray" style="float:right;" onclick="logout()">退出登录</button>
        <h1>工商联工作台</h1>

      <!-- 资质审核 -->
      <section id="tab-qualification" class="tab card">
        <h2>企业资质审核</h2>
        <div class="muted">根据企业问卷得分与指标，判断是否符合升级条件。</div>
        <div class="toolbar">
          <label>筛选级别：
            <select id="levelFilter">
              <option value="auto">按我的审核级别</option>
              <option value="beginner">初级 (市级)</option>
              <option value="intermediate">中级 (省级)</option>
              <option value="advanced">高级 (国家级)</option>
            </select>
          </label>
          <button class="btn" onclick="loadReviews()">刷新</button>
        </div>
        <table id="tblReviews" class="table">
          <thead>
            <tr>
              <th>企业名称</th>
              <th>当前级别</th>
              <th>提交时间</th>
              <th>得分率</th>
              <th>是否可升级</th>
              <th>建议升级至</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 专项反馈列表 -->
      <section id="tab-special-list" class="tab card" style="display:none">
        <h2>专项反馈管理</h2>
        <div class="muted">查看和管理企业提交的各类专项反馈，包括典型案例、问题反馈、工商联反馈等。</div>
        
        <!-- 搜索和筛选 -->
        <div class="toolbar">
          <input id="feedbackKeyword" class="remark" placeholder="搜索反馈标题" />
          <select id="feedbackCategory" class="remark">
            <option value="">所有类型</option>
            <option value="typical_case">典型案例</option>
            <option value="issue_feedback">问题意见反馈</option>
            <option value="chamber_feedback">工商联反馈</option>
            <option value="expert_feedback">专家评价反馈</option>
            <option value="material">自评报告佐证材料</option>
          </select>
          <select id="feedbackStatus" class="remark">
            <option value="">所有状态</option>
            <option value="draft">草稿</option>
            <option value="submitted">已提交</option>
            <option value="reviewing">审核中</option>
            <option value="approved">已批准</option>
            <option value="rejected">已驳回</option>
          </select>
          <input type="date" id="feedbackDateFrom" class="remark" />
          <input type="date" id="feedbackDateTo" class="remark" />
          <button class="btn" onclick="loadFeedbacks()">查询</button>
          <button class="btn" onclick="showAddFeedbackModal()">新增反馈</button>
        </div>

        <!-- 反馈列表表格 -->
        <table id="tblFeedbacks" class="table">
          <thead>
            <tr>
              <th>反馈类型</th>
              <th>子分类</th>
              <th>标题</th>
              <th>企业</th>
              <th>状态</th>
              <th>评分</th>
              <th>提交时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- 分页 -->
        <div class="toolbar" style="margin-top:15px;justify-content:center;">
          <button class="btn gray" id="feedbackPrevBtn" onclick="feedbackPrevPage()">上一页</button>
          <span id="feedbackPageInfo" style="margin:0 15px;line-height:32px;">第 1 页</span>
          <button class="btn gray" id="feedbackNextBtn" onclick="feedbackNextPage()">下一页</button>
        </div>
      </section>

      <!-- 专项反馈深度分析 -->
      <section id="tab-special-analysis" class="tab card" style="display:none">
        <h2>专项反馈深度分析</h2>
        <div class="muted">对企业反馈进行多维度分析，包括分类分析、时间趋势、评分分布等。</div>

        <!-- 分析日期范围 -->
        <div class="toolbar">
          <label>分析期间:</label>
          <input type="date" id="analysisDateFrom" class="remark" />
          <span style="margin:0 10px;">至</span>
          <input type="date" id="analysisDateTo" class="remark" />
          <button class="btn" onclick="loadFeedbackAnalysis()">生成分析</button>
          <button class="btn dl" onclick="exportAnalysis()">导出报告</button>
        </div>

        <!-- 关键指标卡片 -->
        <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
          <div class="card" style="flex:1;min-width:200px;">
            <div style="font-size:12px;color:#666;">总反馈数</div>
            <div style="font-size:32px;font-weight:bold;color:#4338ca;margin-top:10px;" id="metricTotal">0</div>
          </div>
          <div class="card" style="flex:1;min-width:200px;">
            <div style="font-size:12px;color:#666;">平均评分</div>
            <div style="font-size:32px;font-weight:bold;color:#16a34a;margin-top:10px;" id="metricAvgRating">0</div>
          </div>
          <div class="card" style="flex:1;min-width:200px;">
            <div style="font-size:12px;color:#666;">批准率</div>
            <div style="font-size:32px;font-weight:bold;color:#0ea5e9;margin-top:10px;" id="metricApprovalRate">0%</div>
          </div>
          <div class="card" style="flex:1;min-width:200px;">
            <div style="font-size:12px;color:#666;">平均处理时间</div>
            <div style="font-size:32px;font-weight:bold;color:#f59e0b;margin-top:10px;" id="metricAvgTime">0天</div>
          </div>
        </div>

        <!-- 分析图表 -->
        <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
          <div class="card" style="flex:1;min-width:400px;">
            <h3>反馈类型分布</h3>
            <canvas id="chartCategory" style="max-height:300px;"></canvas>
          </div>
          <div class="card" style="flex:1;min-width:400px;">
            <h3>评分分布</h3>
            <canvas id="chartRating" style="max-height:300px;"></canvas>
          </div>
        </div>

        <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
          <div class="card" style="flex:1;min-width:400px;">
            <h3>时间趋势</h3>
            <canvas id="chartTrend" style="max-height:300px;"></canvas>
          </div>
          <div class="card" style="flex:1;min-width:400px;">
            <h3>状态分布</h3>
            <canvas id="chartStatus" style="max-height:300px;"></canvas>
          </div>
        </div>

        <!-- 问题分析 -->
        <div class="card">
          <h3>问题分析</h3>
          <table id="tblIssueAnalysis" class="table">
            <thead>
              <tr>
                <th>问题类别</th>
                <th>数量</th>
                <th>占比</th>
                <th>主要问题</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- 分析报告 -->
      <section id="tab-special-report" class="tab card" style="display:none">
        <h2>分析报告</h2>
        <div class="muted">查看和管理生成的分析报告。</div>

        <div class="toolbar">
          <button class="btn" onclick="loadReports()">刷新列表</button>
          <button class="btn" onclick="generateReport()">生成新报告</button>
        </div>

        <table id="tblReports" class="table">
          <thead>
            <tr>
              <th>报告名称</th>
              <th>分析期间</th>
              <th>生成时间</th>
              <th>反馈总数</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 反馈新增/编辑模态框 -->
      <div id="feedbackModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;padding:24px;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
          <h2 id="feedbackModalTitle">新增反馈</h2>
          
          <div style="margin-bottom:15px;">
            <label>反馈类型 *</label>
            <select id="formFeedbackCategory" class="remark" style="width:100%;box-sizing:border-box;" onchange="updateSubcategories()">
              <option value="">请选择</option>
              <option value="typical_case">典型案例</option>
              <option value="issue_feedback">问题意见反馈</option>
              <option value="chamber_feedback">工商联反馈</option>
              <option value="expert_feedback">专家评价反馈</option>
              <option value="material">自评报告佐证材料</option>
            </select>
          </div>

          <div style="margin-bottom:15px;">
            <label>子分类 *</label>
            <select id="formFeedbackSubcategory" class="remark" style="width:100%;box-sizing:border-box;">
              <option value="">请先选择反馈类型</option>
            </select>
          </div>

          <div style="margin-bottom:15px;">
            <label>标题 *</label>
            <input id="formFeedbackTitle" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入反馈标题" />
          </div>

          <div style="margin-bottom:15px;">
            <label>内容 *</label>
            <textarea id="formFeedbackContent" class="remark" style="width:100%;box-sizing:border-box;height:120px;" placeholder="输入反馈内容"></textarea>
          </div>

          <div style="margin-bottom:15px;">
            <label>优先级</label>
            <select id="formFeedbackPriority" class="remark" style="width:100%;box-sizing:border-box;">
              <option value="low">低</option>
              <option value="medium" selected>中</option>
              <option value="high">高</option>
              <option value="urgent">紧急</option>
            </select>
          </div>

          <div style="margin-bottom:15px;">
            <label>附件</label>
            <input type="file" id="formFeedbackFiles" class="remark" style="width:100%;box-sizing:border-box;" multiple />
            <div id="fileList" style="margin-top:10px;font-size:12px;color:#666;"></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn gray" onclick="closeFeedbackModal()">取消</button>
            <button class="btn" onclick="saveFeedback()">保存</button>
          </div>
        </div>
      </div>

      <!-- 查看企业报告 -->
      <section id="tab-reports" class="tab card" style="display:none">
        <h2>所有企业报告</h2>
        <div class="muted">查看系统内已生成的所有企业评估报告。</div>
        <table id="tblReports" class="table">
            <thead><tr><th>报告名称</th><th>企业名称</th><th>类型</th><th>大小</th><th>生成时间</th><th>操作</th></tr></thead>
            <tbody></tbody>
        </table>
      </section>

      <!-- 发送报告 -->
      <section id="tab-send-report" class="tab card" style="display:none">
        <h2>手动发送报告</h2>
        <div class="muted">选择一份报告并将其通过邮件发送给指定收件人。</div>
        <div class="toolbar">
          <label for="reportSelector">选择报告：</label>
          <select id="reportSelector"></select>
          <label for="recipientEmail">收件人邮箱：</label>
          <input type="email" id="recipientEmail" placeholder="输入邮箱地址" class="remark">
          <button class="btn" onclick="sendSelectedReport()">发送邮件</button>
        </div>
      </section>

      <!-- 平台：角色管理 -->
      <section id="tab-roles" class="tab card" style="display:none">
        <h2>角色管理</h2>
        <div class="toolbar">
          <input id="roleKeyword" class="remark" placeholder="搜索角色名称/键" />
          <button class="btn" onclick="loadRoles()">查询</button>
          <button class="btn" onclick="showRoleModal()">新增角色</button>
        </div>
        <table id="tblRoles" class="table">
          <thead>
            <tr><th>角色名称</th><th>角色键</th><th>描述</th><th>状态</th><th>创建时间</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 平台：菜单管理 -->
      <section id="tab-menus" class="tab card" style="display:none">
        <h2>菜单管理</h2>
        <div class="toolbar">
          <input id="menuKeyword" class="remark" placeholder="搜索菜单名称/键" />
          <button class="btn" onclick="loadMenus()">查询</button>
          <button class="btn" onclick="showMenuModal()">新增菜单</button>
        </div>
        <table id="tblMenus" class="table">
          <thead>
            <tr><th>名称</th><th>键/路径</th><th>父键</th><th>类型</th><th>排序</th><th>状态</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 平台：权限管理 -->
      <section id="tab-permissions" class="tab card" style="display:none">
        <h2>权限管理</h2>
        <div class="toolbar">
          <label>选择角色：
            <select id="permRoleSelect" onchange="loadPermissions()"></select>
          </label>
          <button class="btn" onclick="saveRolePermissions()">保存权限</button>
        </div>
        <div id="permMenus" class="card" style="padding:12px;max-height:420px;overflow:auto;">
          <div class="muted">请选择角色后加载菜单树...</div>
        </div>
      </section>

      <!-- 平台：邮箱配置 -->
      <section id="tab-email-config" class="tab card" style="display:none">
        <h2>邮箱配置</h2>
        <div class="muted">用于向企业用户发送邮件通知。</div>
        <div class="toolbar" style="flex-direction:column;align-items:stretch;gap:10px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <input id="smtpHost" class="remark" placeholder="SMTP服务器*" />
            <input id="smtpPort" class="remark" placeholder="端口* (如: 465/587)" />
            <input id="smtpUser" class="remark" placeholder="发信账号*" />
            <input id="smtpFrom" class="remark" placeholder="发信显示名" />
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <input id="smtpPass" class="remark" placeholder="授权码/密码* (加密存储)" type="password" />
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="smtpSSL"/> 使用SSL
            </label>
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="smtpTLS"/> 使用STARTTLS
            </label>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn" onclick="saveEmailConfig()">保存</button>
            <input id="testEmailTo" class="remark" placeholder="测试收件人邮箱" />
            <button class="btn dl" onclick="testEmailConfig()">发送测试邮件</button>
          </div>
        </div>
      </section>

      <!-- 平台：短信网关 -->
      <section id="tab-sms-gateway" class="tab card" style="display:none">
        <h2>短信网关配置</h2>
        <div class="muted">用于向企业用户发送短信通知。</div>
        <div class="toolbar" style="flex-direction:column;align-items:stretch;gap:10px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <input id="smsProvider" class="remark" placeholder="服务商(如: 阿里云, 腾讯云)" />
            <input id="smsEndpoint" class="remark" placeholder="网关接口地址(可选)" />
            <input id="smsSign" class="remark" placeholder="短信签名*" />
            <input id="smsTemplate" class="remark" placeholder="模板ID*" />
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <input id="smsKey" class="remark" placeholder="AccessKey*" />
            <input id="smsSecret" class="remark" placeholder="Secret*" type="password" />
            <select id="smsStatus" class="remark">
              <option value="active">启用</option>
              <option value="inactive">停用</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn" onclick="saveSmsGateway()">保存</button>
            <input id="testSmsTo" class="remark" placeholder="测试手机号" />
            <button class="btn dl" onclick="testSmsGateway()">发送测试短信</button>
          </div>
        </div>
      </section>

      <!-- 专家辅导记录 -->
      <section id="tab-tutoring" class="tab card" style="display:none">
        <h2>专家辅导记录</h2>
        <div class="muted">查看专家与企业之间的沟通记录。</div>
        <table id="tblTutoring" class="table">
            <thead><tr><th>专家</th><th>企业</th><th>消息内容</th><th>时间</th></tr></thead>
            <tbody></tbody>
        </table>
      </section>

      <!-- 工商联用户管理 -->
      <section id="tab-chamber-users" class="tab card" style="display:none">
        <h2>工商联用户管理</h2>
        <div class="muted">管理工商联系统的用户账户和权限。不同层级用户只能看到权限范围内的用户。</div>
        
        <!-- 搜索和筛选 -->
        <div class="toolbar">
          <input id="userKeyword" class="remark" placeholder="搜索用户名/邮箱/真实姓名" />
          <select id="userLevelFilter" class="remark">
            <option value="">所有层级</option>
            <option value="county">县市级</option>
            <option value="province">省级</option>
            <option value="national">全联</option>
          </select>
          <select id="userRoleFilter" class="remark">
            <option value="">所有角色</option>
            <option value="admin">管理员</option>
            <option value="reviewer">审核员</option>
            <option value="operator">操作员</option>
          </select>
          <select id="userStatusFilter" class="remark">
            <option value="">所有状态</option>
            <option value="active">激活</option>
            <option value="inactive">停用</option>
            <option value="pending">待审核</option>
          </select>
          <button class="btn" onclick="loadChamberUsers()">查询</button>
          <button class="btn" onclick="showAddUserModal()">新增用户</button>
          <button class="btn dl" onclick="exportUsers()">导出</button>
        </div>

        <!-- 用户列表表格 -->
        <table id="tblChamberUsers" class="table">
            <thead>
              <tr>
                <th>用户名</th>
                <th>真实姓名</th>
                <th>邮箱</th>
                <th>手机</th>
                <th>层级</th>
                <th>地区</th>
                <th>角色</th>
                <th>审核权限</th>
                <th>部门</th>
                <th>职位</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- 分页 -->
        <div class="toolbar" style="margin-top:15px;justify-content:center;">
          <button class="btn gray" id="prevBtn" onclick="prevPage()">上一页</button>
          <span id="pageInfo" style="margin:0 15px;line-height:32px;">第 1 页</span>
          <button class="btn gray" id="nextBtn" onclick="nextPage()">下一页</button>
        </div>
      </section>

      <!-- 用户编辑/新增模态框 -->
      <div id="userModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
          <h2 id="modalTitle">新增用户</h2>
          
          <div style="margin-bottom:15px;">
            <label>用户名 *</label>
            <input id="formUsername" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入用户名" />
          </div>

          <div style="margin-bottom:15px;">
            <label>邮箱 *</label>
            <input id="formEmail" type="email" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入邮箱" />
          </div>

          <div style="margin-bottom:15px;">
            <label>密码 * <span id="passwordNote" style="color:#999;font-size:12px;">(新增时必填)</span></label>
            <input id="formPassword" type="password" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入密码(至少8位)" />
          </div>

          <div style="margin-bottom:15px;">
            <label>真实姓名</label>
            <input id="formRealName" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入真实姓名" />
          </div>

          <div style="margin-bottom:15px;">
            <label>手机号</label>
            <input id="formPhone" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入手机号" />
          </div>

          <div style="display:flex;gap:15px;margin-bottom:15px;">
            <div style="flex:1;">
              <label>层级 *</label>
              <select id="formLevel" class="remark" style="width:100%;box-sizing:border-box;">
                <option value="county">县市级</option>
                <option value="province">省级</option>
                <option value="national">全联</option>
              </select>
            </div>
            <div style="flex:1;">
              <label>地区 *</label>
              <input id="formRegion" class="remark" style="width:100%;box-sizing:border-box;" placeholder="如：北京市朝阳区" />
            </div>
          </div>

          <div style="display:flex;gap:15px;margin-bottom:15px;">
            <div style="flex:1;">
              <label>角色 *</label>
              <select id="formRole" class="remark" style="width:100%;box-sizing:border-box;">
                <option value="operator">操作员</option>
                <option value="reviewer">审核员</option>
                <option value="admin">管理员</option>
              </select>
            </div>
            <div style="flex:1;">
              <label>审核权限等级</label>
              <select id="formReviewLevel" class="remark" style="width:100%;box-sizing:border-box;">
                <option value="">无</option>
                <option value="beginner">初级(市级)</option>
                <option value="intermediate">中级(省级)</option>
                <option value="advanced">高级(国家级)</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:15px;margin-bottom:15px;">
            <div style="flex:1;">
              <label>部门</label>
              <input id="formDepartment" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入部门" />
            </div>
            <div style="flex:1;">
              <label>职位</label>
              <input id="formPosition" class="remark" style="width:100%;box-sizing:border-box;" placeholder="输入职位" />
            </div>
          </div>

          <div style="margin-bottom:15px;">
            <label>状态</label>
            <select id="formStatus" class="remark" style="width:100%;box-sizing:border-box;">
              <option value="pending">待审核</option>
              <option value="active">激活</option>
              <option value="inactive">停用</option>
            </select>
          </div>

          <div style="margin-bottom:15px;">
            <label>备注</label>
            <textarea id="formRemark" class="remark" style="width:100%;box-sizing:border-box;height:80px;" placeholder="输入备注"></textarea>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn gray" onclick="closeUserModal()">取消</button>
            <button class="btn" onclick="saveUser()">保存</button>
          </div>
        </div>
      </div>

      <!-- 指标体系管理 -->
      <section id="tab-indicators" class="tab card" style="display:none">
        <h2>指标体系管理</h2>
        <div class="muted">对一、二、三级评价指标进行增删改查，树形结构展示；支持按基础类/拔高类等分类筛选。</div>
        <div class="toolbar">
          <select id="indicatorTypeFilter" class="remark">
            <option value="">全部类型</option>
            <option value="基础类">基础类</option>
            <option value="拔高类">拔高类</option>
            <option value="创新类">创新类</option>
            <option value="责任类">责任类</option>
            <option value="其他类">其他类</option>
          </select>
          <button class="btn" onclick="loadIndicatorsTree()">刷新</button>
          <button class="btn" onclick="showIndicatorModal()">新增指标</button>
        </div>
        <div id="indicatorTree" class="card" style="padding:12px;max-height:420px;overflow:auto;">
          <div class="muted">加载中...</div>
        </div>
      </section>

      <!-- 评分规则管理 -->
      <section id="tab-scoring-rules" class="tab card" style="display:none">
        <h2>评分规则管理</h2>
        <div class="muted">根据指标体系设计初级/中级/高级评分规则，支持增删改查。</div>
        <div class="toolbar">
          <input id="ruleIndicatorId" class="remark" placeholder="指标ID(可选)" />
          <select id="ruleLevelFilter" class="remark">
            <option value="">全部等级</option>
            <option value="初级">初级</option>
            <option value="中级">中级</option>
            <option value="高级">高级</option>
          </select>
          <button class="btn" onclick="loadScoringRules()">查询</button>
          <button class="btn" onclick="showRuleModal()">新增规则</button>
        </div>
        <table id="tblScoringRules" class="table">
          <thead>
            <tr><th>规则ID</th><th>指标ID</th><th>等级</th><th>分值范围</th><th>更新时间</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 企业问卷管理 -->
      <section id="tab-enterprise-surveys" class="tab card" style="display:none">
        <h2>企业问卷管理</h2>
        <div class="muted">根据指标体系设计初级/中级/高级企业问卷，支持状态切换与使用范围设置。</div>
        <div class="toolbar">
          <select id="entSurveyLevel" class="remark">
            <option value="">全部等级</option>
            <option value="初级">初级</option>
            <option value="中级">中级</option>
            <option value="高级">高级</option>
          </select>
          <select id="entSurveyStatus" class="remark">
            <option value="">全部状态</option>
            <option value="active">使用</option>
            <option value="inactive">关闭</option>
          </select>
          <button class="btn" onclick="loadEnterpriseSurveys()">查询</button>
          <button class="btn" onclick="showEnterpriseSurveyModal()">新建问卷</button>
        </div>
        <table id="tblEnterpriseSurveys" class="table">
          <thead>
            <tr><th>名称</th><th>等级</th><th>状态</th><th>问题数</th><th>更新时间</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 专家问卷管理 -->
      <section id="tab-expert-surveys" class="tab card" style="display:none">
        <h2>专家问卷管理</h2>
        <div class="muted">针对不同类型专家设计问卷，支持状态切换与范围设置。</div>
        <div class="toolbar">
          <input id="expertTypeFilter" class="remark" placeholder="专家类型(如: 技术专家)" />
          <select id="expSurveyStatus" class="remark">
            <option value="">全部状态</option>
            <option value="active">使用</option>
            <option value="inactive">关闭</option>
          </select>
          <button class="btn" onclick="loadExpertSurveys()">查询</button>
          <button class="btn" onclick="showExpertSurveyModal()">新建问卷</button>
        </div>
        <table id="tblExpertSurveys" class="table">
          <thead>
            <tr><th>名称</th><th>专家类型</th><th>状态</th><th>问题数</th><th>更新时间</th><th>操作</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 指标/规则/问卷通用模态框 -->
      <div id="modalMask" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1200;justify-content:center;align-items:center;">
        <div class="card" style="width:92%;max-width:780px;max-height:90vh;overflow:auto;">
          <h2 id="modalTitleText">编辑</h2>
          <div id="modalBody"></div>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
            <button class="btn gray" onclick="closeModal()">取消</button>
            <button class="btn" id="modalSaveBtn">保存</button>
          </div>
        </div>
      </div>

      <!-- 企业信息 -->
      <section id="tab-enterprise-info" class="tab card" style="display:none">
        <h2>企业信息</h2>
        <div class="toolbar">
          <input id="entKeyword" class="remark" placeholder="搜索企业名称" />
          <button class="btn" onclick="loadEnterpriseTable()">查询</button>
        </div>
        <table id="tblEnterprises" class="table">
          <thead><tr><th>名称</th><th>地区</th><th>行业</th><th>等级</th><th>联系人</th><th>邮箱</th><th>电话</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3 style="margin-top:14px">新增/编辑</h3>
        <div class="toolbar">
          <input id="entId" type="hidden" />
          <input id="entName" class="remark" placeholder="企业名称" />
          <input id="entRegion" class="remark" placeholder="地区" />
          <input id="entIndustry" class="remark" placeholder="行业" />
          <select id="entLevel" class="remark"><option value="beginner">初级</option><option value="intermediate">中级</option><option value="advanced">高级</option></select>
          <input id="entContact" class="remark" placeholder="联系人" />
          <input id="entEmail" class="remark" placeholder="邮箱" />
          <input id="entPhone" class="remark" placeholder="电话" />
          <button class="btn" onclick="saveEnterprise()">保存</button>
          <button class="btn gray" onclick="resetEntForm()">清空</button>
        </div>
      </section>

      <!-- 评价升级中心 -->
      <section id="tab-upgrade-center" class="tab card" style="display:none">
        <h2>评价升级</h2>
        <div class="toolbar">
          <label>选择企业：<select id="selUpgradeEnt"></select></label>
          <label>升级至：<select id="selUpgradeTo"><option value="intermediate">中级</option><option value="advanced">高级</option></select></label>
          <button class="btn" onclick="doUpgrade()">执行升级</button>
        </div>
        <div class="muted">说明：此处为人工审核后的手动升级入口，可结合“企业资质审核”的建议升级操作。</div>
      </section>

      <!-- 专家匹配管理 -->
      <section id="tab-expert-match" class="tab card" style="display:none">
        <h2>专家匹配管理</h2>
        <div class="toolbar">
          <label>选择企业：<select id="selMatchEnt"></select></label>
          <button class="btn" onclick="loadExpertMatch()">获取匹配方案</button>
        </div>
        <div id="matchResult" class="muted">请选择企业并点击获取匹配方案。</div>
      </section>

      <!-- 企业自评详情 -->
      <section id="tab-enterprise-history" class="tab card" style="display:none">
        <h2>企业自评详情</h2>
        <div class="toolbar">
          <label>选择企业：<select id="selHistoryEnt"></select></label>
          <button class="btn" onclick="loadEnterpriseHistory()">加载</button>
        </div>
        <table id="tblEntHistory" class="table">
          <thead><tr><th>时间</th><th>分数(%)</th><th>级别</th><th>问卷文件</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 专家辅导台账 -->
      <section id="tab-tutoring-ledger" class="tab card" style="display:none">
        <h2>专家辅导台账</h2>
        <div class="toolbar">
          <label>企业：<select id="selLedgerEnt"></select></label>
          <button class="btn" onclick="loadLedger()">刷新</button>
        </div>
        <table id="tblLedger" class="table">
          <thead><tr><th>时间</th><th>专家</th><th>备注</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar">
          <input id="lgTime" class="remark" placeholder="时间(可不填，默认当前)" />
          <input id="lgExpert" class="remark" placeholder="专家" />
          <input id="lgNote" class="remark" style="width:360px" placeholder="备注" />
          <button class="btn" onclick="addLedger()">新增记录</button>
        </div>
      </section>

      <!-- 专家信息 -->
      <section id="tab-experts-info" class="tab card" style="display:none">
        <h2>专家信息</h2>
        <div class="toolbar">
          <input id="expKeyword" class="remark" placeholder="搜索专家姓名" />
          <button class="btn" onclick="loadExpertsTable()">查询</button>
        </div>
        <table id="tblExperts" class="table">
          <thead><tr><th>姓名</th><th>地区</th><th>省份</th><th>行业</th><th>等级</th><th>电话</th><th>邮箱</th><th>单位</th><th>擅长</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3 style="margin-top:14px">新增/编辑</h3>
        <div class="toolbar">
          <input id="expId" type="hidden"/>
          <input id="expName" class="remark" placeholder="姓名"/>
          <input id="expRegion" class="remark" placeholder="地区(市/县)"/>
          <input id="expProvince" class="remark" placeholder="省份"/>
          <input id="expIndustry" class="remark" placeholder="行业"/>
          <select id="expLevel" class="remark"><option value="county">县市级</option><option value="province">省市级</option><option value="national">国家级</option></select>
          <input id="expPhone" class="remark" placeholder="电话"/>
          <input id="expEmail" class="remark" placeholder="邮箱"/>
          <input id="expOrg" class="remark" placeholder="单位"/>
          <input id="expSkills" class="remark" style="width:260px" placeholder="擅长领域"/>
          <button class="btn" onclick="saveExpert()">保存</button>
          <button class="btn gray" onclick="resetExpForm()">清空</button>
        </div>
      </section>

      <!-- 专家自评详情 -->
      <section id="tab-expert-self" class="tab card" style="display:none">
        <h2>专家自评详情</h2>
        <div class="toolbar">
          <label>专家：<select id="selSelfExp"></select></label>
          <button class="btn" onclick="loadExpertSelf()">加载</button>
        </div>
        <table id="tblExpertSelf" class="table">
          <thead><tr><th>时间</th><th>分数(%)</th><th>级别</th><th>问卷文件</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted">注：当前为占位接口，如有专家自评数据源我可接入。</div>
      </section>

      <!-- 专家评级管理 -->
      <section id="tab-expert-rate" class="tab card" style="display:none">
        <h2>专家评级管理</h2>
        <div class="toolbar">
          <label>专家：<select id="selRateExp"></select></label>
          <label>升级至：<select id="selRateTo"><option value="county">县市级</option><option value="province">省市级</option><option value="national">国家级</option></select></label>
          <button class="btn" onclick="doExpertRate()">执行评级</button>
        </div>
        <div id="rateInfo" class="muted">请选择专家查看当前等级与可辅导范围。</div>
      </section>

      <!-- 专家辅导详情 -->
      <section id="tab-expert-tutoring" class="tab card" style="display:none">
        <h2>专家辅导详情</h2>
        <div class="toolbar">
          <label>专家：<select id="selTutExp"></select></label>
          <button class="btn" onclick="loadExpertTutoring()">加载</button>
        </div>
        <table id="tblExpertTutoring" class="table">
          <thead><tr><th>时间</th><th>企业</th><th>内容</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- 企业评价详情 -->
      <section id="tab-expert-evaluations" class="tab card" style="display:none">
        <h2>企业对专家的评价</h2>
        <div class="toolbar">
          <label>专家：<select id="selEvalExp"></select></label>
          <button class="btn" onclick="loadExpertEvals()">加载</button>
        </div>
        <table id="tblExpertEvals" class="table">
          <thead><tr><th>时间</th><th>企业</th><th>评分</th><th>评价</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3 style="margin-top:14px">新增评价</h3>
        <div class="toolbar">
          <input id="evEnterprise" class="remark" placeholder="企业名称"/>
          <input id="evScore" class="remark" placeholder="评分(0-100)"/>
          <input id="evComment" class="remark" style="width:360px" placeholder="评价内容"/>
          <button class="btn" onclick="addExpertEval()">提交</button>
        </div>
      </section>

    </main>
  </div>

  <script>
    // Tab 切换 + 悬浮子菜单（精确定位）+ 点击展开兜底
    document.addEventListener('DOMContentLoaded', function() {
      // 1) 点击主按钮：点击箭头仅展开二级，点击文字则切换标签
      document.querySelectorAll('.menu .menu-item .menu-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const item = this.closest('.menu-item');
          if (e.target.closest('.menu-arrow')) {
            // 兜底：在某些环境 hover 无效时可点击展开为内嵌
            item.classList.toggle('open');
            e.stopPropagation();
            return;
          }
          switchTab(item.dataset.tab, this);
        });
      });

      // 2) 悬浮显示（使用 fixed 定位，避免被容器裁剪）
      const items = document.querySelectorAll('.menu .menu-item');
      items.forEach(item => {
        const submenu = item.querySelector('.submenu-tooltip');
        if (!submenu) return;
        let hideTimer = null;
        const show = () => {
          const rect = item.getBoundingClientRect();
          // 计算位置：出现在菜单项右侧，且不超出窗口底部
          submenu.style.display = 'block';
          // 先临时显示后再取高度
          const sw = submenu.offsetWidth;
          const sh = submenu.offsetHeight;
          let left = rect.right - 2;
          let top  = rect.top;
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          // 若右侧空间不足，贴在左侧
          if (left + sw > vw - 8) left = Math.max(8, rect.left - sw + 2);
          // 若底部溢出，向上提
          if (top + sh > vh - 8) top = Math.max(8, vh - sh - 8);
          submenu.style.left = left + 'px';
          submenu.style.top  = top  + 'px';
        };
        const hide = () => { submenu.style.display = 'none'; };
        item.addEventListener('mouseenter', () => { clearTimeout(hideTimer); show(); });
        item.addEventListener('mouseleave', () => { hideTimer = setTimeout(hide, 120); });
        submenu.addEventListener('mouseenter', () => { clearTimeout(hideTimer); submenu.style.display = 'block'; });
        submenu.addEventListener('mouseleave', () => { hideTimer = setTimeout(hide, 120); });
      });

      // 3) 子菜单点击不冒泡
      document.querySelectorAll('.submenu-item').forEach(el => {
        el.addEventListener('click', function(ev){ ev.stopPropagation(); });
      });
    });

    function switchTab(id, btn){
      document.querySelectorAll('.menu .menu-item').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(sec=>sec.style.display='none');
      const s = document.getElementById('tab-'+id); if(s) s.style.display='block';
      // 统一填充企业下拉
      if(['upgrade-center','expert-match','enterprise-history','tutoring-ledger'].includes(id)){
        fillEnterpriseSelects();
      }
      // 统一填充专家下拉
      if(['expert-self','expert-rate','expert-tutoring','expert-evaluations'].includes(id)){
        fillExpertSelects();
      }
      // 按需加载数据
      if(id==='qualification') loadReviews();
      if(id==='special') loadSpecials();
      if(id==='reports') loadAllReports();
      if(id==='send-report') loadReportsForSelector();
      if(id==='tutoring') loadTutoringRecords();
      if(id==='chamber-users') loadChamberUsers();
      if(id==='questionnaire-mgmt') loadQuestionnaires();
      if(id==='enterprise-info') loadEnterpriseTable();
      if(id==='experts-info') loadExpertsTable();
      // 新增：问卷相关tab按需加载
      if(id==='indicators') loadIndicatorsTree();
      if(id==='scoring-rules') loadScoringRules();
      if(id==='enterprise-surveys') loadEnterpriseSurveys();
      if(id==='expert-surveys') loadExpertSurveys();
      // 新增：平台基础功能管理
      if(id==='roles') loadRoles();
      if(id==='menus') loadMenus();
      if(id==='permissions') initPermissionsTab();
      if(id==='email-config') loadEmailConfig();
      if(id==='sms-gateway') loadSmsGateway();
    }

    async function fillEnterpriseSelects(){
      const res = await fetch('/api/portal/chamber/enterprises');
      const data = await res.json();
      const opts = (data.items||[]).map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
      ['selUpgradeEnt','selMatchEnt','selHistoryEnt','selLedgerEnt'].forEach(id=>{
        const el = document.getElementById(id); if(el){ el.innerHTML = opts; }
      });
    }

    async function loadEnterpriseTable(){
      const kw = document.getElementById('entKeyword').value.trim();
      const url = kw? `/api/portal/chamber/enterprises?q=${encodeURIComponent(kw)}` : '/api/portal/chamber/enterprises';
      const res = await fetch(url); const data = await res.json();
      const tb = document.querySelector('#tblEnterprises tbody'); tb.innerHTML='';
      (data.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.name}</td><td>${it.region||''}</td><td>${it.industry||''}</td><td>${it.level||''}</td><td>${it.contact||''}</td><td>${it.email||''}</td><td>${it.phone||''}</td>
        <td><button class='btn' onclick='editEnt("${it.id}")'>编辑</button> <button class='btn no' onclick='delEnt("${it.id}")'>删除</button></td>`;
        tb.appendChild(tr);
      })
    }
    function resetEntForm(){ ['entId','entName','entRegion','entIndustry','entContact','entEmail','entPhone'].forEach(id=>document.getElementById(id).value=''); document.getElementById('entLevel').value='beginner'; }
    async function saveEnterprise(){
      const body={id:document.getElementById('entId').value||undefined,name:entName.value.trim(),region:entRegion.value.trim(),industry:entIndustry.value.trim(),level:entLevel.value,contact:entContact.value.trim(),email:entEmail.value.trim(),phone:entPhone.value.trim()};
      const res = await fetch('/api/portal/chamber/enterprises/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data = await res.json(); if(!data.success){alert(data.error||'保存失败');return;} resetEntForm(); loadEnterpriseTable(); fillEnterpriseSelects(); }
    async function editEnt(id){
      const res = await fetch('/api/portal/chamber/enterprises'); const data = await res.json(); const it=(data.items||[]).find(x=>x.id===id); if(!it)return; entId.value=it.id; entName.value=it.name||''; entRegion.value=it.region||''; entIndustry.value=it.industry||''; entLevel.value=it.level||'beginner'; entContact.value=it.contact||''; entEmail.value=it.email||''; entPhone.value=it.phone||'';
    }
    async function delEnt(id){ if(!confirm('确定删除?'))return; const res=await fetch(`/api/portal/chamber/enterprises/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadEnterpriseTable(); fillEnterpriseSelects(); }

    async function doUpgrade(){ const name=document.getElementById('selUpgradeEnt').value; const to=document.getElementById('selUpgradeTo').value; const res=await fetch('/api/portal/chamber/upgrade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enterprise:name,to_level:to})}); const data=await res.json(); if(!data.success){alert(data.error||'升级失败');return;} alert('升级成功'); }
    async function loadExpertMatch(){ const name=document.getElementById('selMatchEnt').value; const res=await fetch(`/api/portal/chamber/expert-match?enterprise=${encodeURIComponent(name)}`); const data=await res.json(); if(!data.success){matchResult.textContent=data.error||'失败';return;} const d=data.data; matchResult.innerHTML=`推荐专家组：<b>${d.recommend_group}</b>（优先级：${d.priority}）<br/>地区：${d.region}，行业：${d.industry}，最近得分：${d.last_score_pct.toFixed(1)}%`; }
    async function loadEnterpriseHistory(){ const name=document.getElementById('selHistoryEnt').value; const res=await fetch(`/api/portal/chamber/enterprise-history?enterprise=${encodeURIComponent(name)}`); const data=await res.json(); const tb=document.querySelector('#tblEntHistory tbody'); tb.innerHTML=''; (data.items||[]).forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.time_text}</td><td>${it.score_pct.toFixed(1)}</td><td>${it.level}</td><td>${it.excel_file}</td>`; tb.appendChild(tr); }); }
    async function loadLedger(){ const name=document.getElementById('selLedgerEnt').value; const res=await fetch(`/api/portal/chamber/tutoring-ledger?enterprise=${encodeURIComponent(name)}`); const data=await res.json(); const tb=document.querySelector('#tblLedger tbody'); tb.innerHTML=''; (data.items||[]).forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.time}</td><td>${it.expert}</td><td>${it.note}</td>`; tb.appendChild(tr); }); }
    async function addLedger(){ const name=document.getElementById('selLedgerEnt').value; const body={enterprise:name,time:lgTime.value.trim()||undefined,expert:lgExpert.value.trim(),note:lgNote.value.trim()}; const res=await fetch('/api/portal/chamber/tutoring-ledger',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const data=await res.json(); if(!data.success){alert(data.error||'新增失败');return;} lgTime.value=''; lgExpert.value=''; lgNote.value=''; loadLedger(); }


    async function logout(){ await fetch('/logout',{method:'POST'}); location.href='/'; }

    // 资质审核
    async function approveUpgrade(username, newLevel) {
      if (!confirm(`确定要将用户 ${username} 的等级提升为 ${newLevel} 吗？`)) return;
      const res = await fetch('/api/portal/chamber/approve-upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: username, new_level: newLevel })
      });
      const data = await res.json();
      if (data.success) {
        alert('升级成功！');
        loadReviews();
      } else {
        alert('操作失败：' + (data.error || ''));
      }
    }

    async function loadReviews(){
      const level = document.getElementById('levelFilter').value;
      const url = level==='auto'? '/api/portal/chamber/reviews' : `/api/portal/chamber/reviews?level=${level}`;
      const res = await fetch(url); const data = await res.json();
      const tbody = document.querySelector('#tblReviews tbody'); tbody.innerHTML='';
      if(!data.success){ tbody.innerHTML = `<tr><td colspan="7" style="color:#ef4444;">${data.error||'加载失败'}</td></tr>`; return; }
      data.items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.enterprise_name||''}</td>
          <td>${it.current_level||''}</td>
          <td>${it.submit_time_text||''}</td>
          <td>${it.score_percentage?.toFixed(1)||'-'}%</td>
          <td>${it.eligible?'<span class="tag ok">可升级</span>':'<span class="tag no">不符合</span>'}</td>
          <td>${it.upgrade_to||'-'}</td>
          <td>
            ${it.excel_file ? `<a class="btn dl" href="/download/submission/${encodeURIComponent(it.excel_file)}" target="_blank">查看问卷</a>` : '<span class="muted">无问卷</span>'}
            ${it.report_file ? `<a class="btn dl" href="/download/${encodeURIComponent(it.report_file)}" target="_blank">查看报告</a>` : '<span class="muted">无报告</span>'}
            ${(it.eligible && it.upgrade_to) ? `<button class="btn ok" onclick="approveUpgrade('${it.username}','${it.upgrade_to}')">批准升级</button>` : ''}
            ${it.next_level ? `<button class="btn" onclick="manualUpgrade('${it.username}','${it.next_level}')">手动晋级</button>` : '<span class="muted">已最高级</span>'}
          </td>`;
        tbody.appendChild(tr);
      })
    }

    // 专项审核
    async function loadSpecials(){
      const level = document.getElementById('levelFilter').value;
      const url = level==='auto'? '/api/special/list' : `/api/special/list?level=${level}`;
      const res = await fetch(url); const data = await res.json();
      const tb = document.querySelector('#spTbl tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan="9" style="color:#ef4444;">${data.error||'加载失败'}</td></tr>`; return; }
      data.items.forEach(it=>{
        const tr=document.createElement('tr');
        const files = (it.files||[]).map(fn=>`<button class="btn dl" onclick="down('${it.id}','${fn}')">下载</button>`).join(' ');
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${it.enterprise||''}</td>
          <td>${it.title||''}</td>
          <td>${it.time_text||''}</td>
          <td>${it.level||''}</td>
          <td>${files||'-'}</td>
          <td>${badge(it.status)}</td>
          <td>${it.remark||''}</td>
          <td>
            <input class="remark" id="r_${it.id}" placeholder="备注"/>
            <button class="btn ok" onclick="review('${it.id}','approve')">通过</button>
            <button class="btn no" onclick="review('${it.id}','reject')">驳回</button>
          </td>`;
        tb.appendChild(tr);
      })
    }
    function badge(s){
      if(s==='approved') return '<span class="tag ok">已通过</span>';
      if(s==='rejected') return '<span class="tag no">已驳回</span>';
      return '<span class="tag warn">待审核</span>';
    }
    function down(id,fn){ window.open(`/api/special/download/${id}/${encodeURIComponent(fn)}`,'_blank'); }
    async function review(id,action){
      const remark = document.getElementById(`r_${id}`).value.trim();
      const res = await fetch('/api/special/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,action,remark})});
      const data = await res.json();
      if(data.success){ loadSpecials(); } else { alert('操作失败：'+(data.error||'')); }
    }

    // 专家辅导记录
    async function loadTutoringRecords() {
      const res = await fetch('/api/portal/chamber/tutoring-records');
      const data = await res.json();
      const tbody = document.querySelector('#tblTutoring tbody');
      tbody.innerHTML = '';
      if (data.success) {
        data.records.forEach(rec => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${rec.expert}</td><td>${rec.enterprise}</td><td>${rec.message}</td><td>${rec.time}</td>`;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan=\"4\">加载失败</td></tr>`;
      }
    }

    // 发送报告
    async function loadReportsForSelector() {
      const res = await fetch('/api/portal/chamber/all-reports');
      const data = await res.json();
      const selector = document.getElementById('reportSelector');
      selector.innerHTML = '';
      if (data.success) {
        data.reports.forEach(report => {
          const option = document.createElement('option');
          option.value = report.filename;
          option.textContent = report.filename;
          selector.appendChild(option);
        });
      }
    }

    async function sendSelectedReport() {
      const report_filename = document.getElementById('reportSelector').value;
      const recipient = document.getElementById('recipientEmail').value;
      if (!recipient) {
        alert('请输入收件人邮箱');
        return;
      }
      if (!report_filename) {
        alert('请选择要发送的报告');
        return;
      }
      const res = await fetch('/api/portal/chamber/send-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recipient, report_filename })
      });
      const data = await res.json();
      if (data.success) {
        alert('邮件发送成功！');
      } else {
        alert('发送失败：' + (data.error || ''));
      }
    }

    // 查看企业报告
    async function loadAllReports(){
        const res = await fetch('/api/portal/chamber/all-reports');
        const data = await res.json();
        const tbody = document.querySelector('#tblReports tbody');
        tbody.innerHTML = '';
        if (!data.success) {
            tbody.innerHTML = `<tr><td colspan="6">${data.error || '加载失败'}</td></tr>`;
            return;
        }
        data.reports.forEach(report => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${report.filename}</td>
                <td>${report.enterprise_name}</td>
                <td>${report.type}</td>
                <td>${(report.file_size / 1024).toFixed(1)} KB</td>
                <td>${new Date(report.created_time * 1000).toLocaleString()}</td>
                <td><a href="/download/${encodeURIComponent(report.filename)}" class="btn" target="_blank">下载</a></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 工商联用户管理 - 全局变量
    let chamberUserState = {
      currentPage: 1,
      pageSize: 20,
      total: 0,
      editingUserId: null,
      allUsers: []
    };

    // 加载工商联用户列表
    async function loadChamberUsers(){
      try {
        const keyword = document.getElementById('userKeyword').value.trim();
        const level = document.getElementById('userLevelFilter').value;
        const role = document.getElementById('userRoleFilter').value;
        const status = document.getElementById('userStatusFilter').value;
        
        let url = `/api/portal/chamber/users?page=${chamberUserState.currentPage}&limit=${chamberUserState.pageSize}`;
        if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
        if (level) url += `&level=${level}`;
        if (role) url += `&role=${role}`;
        if (status) url += `&status=${status}`;

        const res = await fetch(url);
        const data = await res.json();
        const tbody = document.querySelector('#tblChamberUsers tbody');
        tbody.innerHTML = '';

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="13" style="color:#ef4444;">${data.error || '加载失败'}</td></tr>`;
          return;
        }

        if (!data.data || !data.data.users || data.data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:#999;">暂无用户数据</td></tr>';
          chamberUserState.total = 0;
          updatePagination();
          return;
        }

        chamberUserState.total = data.data.total;
        chamberUserState.allUsers = data.data.users;

        data.data.users.forEach(user => {
          const tr = document.createElement('tr');
          const statusBadge = {
            'active': '<span class="tag ok">激活</span>',
            'inactive': '<span class="tag no">停用</span>',
            'pending': '<span class="tag warn">待审核</span>'
          }[user.status] || '-';

          const reviewLevel = {
            'beginner': '初级(市级)',
            'intermediate': '中级(省级)',
            'advanced': '高级(国家级)'
          }[user.review_level] || '-';

          const levelText = {
            'county': '县市级',
            'province': '省级',
            'national': '全联'
          }[user.level] || '-';

          const roleText = {
            'admin': '管理员',
            'reviewer': '审核员',
            'operator': '操作员'
          }[user.role] || '-';

          tr.innerHTML = `
            <td>${user.username || '-'}</td>
            <td>${user.real_name || '-'}</td>
            <td>${user.email || '-'}</td>
            <td>${user.phone || '-'}</td>
            <td>${levelText}</td>
            <td>${user.region || '-'}</td>
            <td>${roleText}</td>
            <td>${reviewLevel}</td>
            <td>${user.department || '-'}</td>
            <td>${user.position || '-'}</td>
            <td>${statusBadge}</td>
            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
            <td>
              <button class="btn" onclick="editChamberUser('${user.id}')">编辑</button>
              <button class="btn no" onclick="deleteChamberUser('${user.id}')">删除</button>
              ${user.status === 'active' ? `<button class="btn warn" onclick="toggleUserStatus('${user.id}', 'inactive')">停用</button>` : `<button class="btn ok" onclick="toggleUserStatus('${user.id}', 'active')">启用</button>`}
            </td>
          `;
          tbody.appendChild(tr);
        });

        updatePagination();
      } catch (error) {
        console.error('加载用户失败:', error);
        document.querySelector('#tblChamberUsers tbody').innerHTML = '<tr><td colspan="13" style="color:#ef4444;">加载失败</td></tr>';
      }
    }

    // 更新分页信息
    function updatePagination(){
      const totalPages = Math.ceil(chamberUserState.total / chamberUserState.pageSize);
      document.getElementById('pageInfo').textContent = `第 ${chamberUserState.currentPage} 页 / 共 ${totalPages} 页 (总计 ${chamberUserState.total} 条)`;
      document.getElementById('prevBtn').disabled = chamberUserState.currentPage <= 1;
      document.getElementById('nextBtn').disabled = chamberUserState.currentPage >= totalPages;
    }

    // 上一页
    function prevPage(){
      if (chamberUserState.currentPage > 1) {
        chamberUserState.currentPage--;
        loadChamberUsers();
      }
    }

    // 下一页
    function nextPage(){
      const totalPages = Math.ceil(chamberUserState.total / chamberUserState.pageSize);
      if (chamberUserState.currentPage < totalPages) {
        chamberUserState.currentPage++;
        loadChamberUsers();
      }
    }

    // 显示新增用户模态框
    function showAddUserModal(){
      chamberUserState.editingUserId = null;
      document.getElementById('modalTitle').textContent = '新增用户';
      document.getElementById('passwordNote').textContent = '(新增时必填)';
      document.getElementById('formPassword').required = true;
      resetUserForm();
      document.getElementById('userModal').style.display = 'flex';
    }

    // 关闭模态框
    function closeUserModal(){
      document.getElementById('userModal').style.display = 'none';
      resetUserForm();
    }

    // 重置表单
    function resetUserForm(){
      document.getElementById('formUsername').value = '';
      document.getElementById('formEmail').value = '';
      document.getElementById('formPassword').value = '';
      document.getElementById('formRealName').value = '';
      document.getElementById('formPhone').value = '';
      document.getElementById('formLevel').value = 'county';
      document.getElementById('formRegion').value = '';
      document.getElementById('formRole').value = 'operator';
      document.getElementById('formReviewLevel').value = '';
      document.getElementById('formDepartment').value = '';
      document.getElementById('formPosition').value = '';
      document.getElementById('formStatus').value = 'pending';
      document.getElementById('formRemark').value = '';
    }

    // 编辑用户
    async function editChamberUser(userId){
      try {
        const res = await fetch(`/api/portal/chamber/users/${userId}`);
        const data = await res.json();
        
        if (!data.success) {
          alert('加载用户信息失败');
          return;
        }

        const user = data.data;
        chamberUserState.editingUserId = userId;
        document.getElementById('modalTitle').textContent = '编辑用户';
        document.getElementById('passwordNote').textContent = '(留空不修改密码)';
        document.getElementById('formPassword').required = false;

        document.getElementById('formUsername').value = user.username || '';
        document.getElementById('formUsername').disabled = true;
        document.getElementById('formEmail').value = user.email || '';
        document.getElementById('formPassword').value = '';
        document.getElementById('formRealName').value = user.real_name || '';
        document.getElementById('formPhone').value = user.phone || '';
        document.getElementById('formLevel').value = user.level || 'county';
        document.getElementById('formRegion').value = user.region || '';
        document.getElementById('formRole').value = user.role || 'operator';
        document.getElementById('formReviewLevel').value = user.review_level || '';
        document.getElementById('formDepartment').value = user.department || '';
        document.getElementById('formPosition').value = user.position || '';
        document.getElementById('formStatus').value = user.status || 'pending';
        document.getElementById('formRemark').value = user.remark || '';

        document.getElementById('userModal').style.display = 'flex';
      } catch (error) {
        console.error('编辑用户失败:', error);
        alert('加载用户信息失败');
      }
    }

    // 保存用户
    async function saveUser(){
      const username = document.getElementById('formUsername').value.trim();
      const email = document.getElementById('formEmail').value.trim();
      const password = document.getElementById('formPassword').value.trim();
      const realName = document.getElementById('formRealName').value.trim();
      const phone = document.getElementById('formPhone').value.trim();
      const level = document.getElementById('formLevel').value;
      const region = document.getElementById('formRegion').value.trim();
      const role = document.getElementById('formRole').value;
      const reviewLevel = document.getElementById('formReviewLevel').value;
      const department = document.getElementById('formDepartment').value.trim();
      const position = document.getElementById('formPosition').value.trim();
      const status = document.getElementById('formStatus').value;
      const remark = document.getElementById('formRemark').value.trim();

      // 验证必填字段
      if (!username || !email || !level || !region || !role) {
        alert('请填写所有必填字段');
        return;
      }

      if (!chamberUserState.editingUserId && !password) {
        alert('新增用户时密码必填');
        return;
      }

      if (password && password.length < 8) {
        alert('密码至少8位');
        return;
      }

      try {
        const method = chamberUserState.editingUserId ? 'PUT' : 'POST';
        const url = chamberUserState.editingUserId 
          ? `/api/portal/chamber/users/${chamberUserState.editingUserId}`
          : '/api/portal/chamber/users';

        const body = {
          username,
          email,
          real_name: realName,
          phone,
          level,
          region,
          role,
          review_level: reviewLevel || null,
          department,
          position,
          status,
          remark
        };

        if (password) {
          body.password = password;
        }

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!data.success) {
          alert(data.error || '保存失败');
          return;
        }

        alert('保存成功');
        closeUserModal();
        chamberUserState.currentPage = 1;
        loadChamberUsers();
      } catch (error) {
        console.error('保存用户失败:', error);
        alert('保存失败');
      }
    }

    // 删除用户
    async function deleteChamberUser(userId){
      if (!confirm('确定要删除这个用户吗？此操作不可撤销。')) {
        return;
      }

      try {
        const res = await fetch(`/api/portal/chamber/users/${userId}`, {
          method: 'DELETE'
        });

        const data = await res.json();
        if (!data.success) {
          alert(data.error || '删除失败');
          return;
        }

        alert('删除成功');
        loadChamberUsers();
      } catch (error) {
        console.error('删除用户失败:', error);
        alert('删除失败');
      }
    }

    // 切换用户状态
    async function toggleUserStatus(userId, newStatus){
      try {
        const res = await fetch(`/api/portal/chamber/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await res.json();
        if (!data.success) {
          alert(data.error || '操作失败');
          return;
        }

        alert('状态更新成功');
        loadChamberUsers();
      } catch (error) {
        console.error('更新状态失败:', error);
        alert('操作失败');
      }
    }

    // 导出用户
    async function exportUsers(){
      try {
        const keyword = document.getElementById('userKeyword').value.trim();
        const level = document.getElementById('userLevelFilter').value;
        const role = document.getElementById('userRoleFilter').value;
        const status = document.getElementById('userStatusFilter').value;
        
        let url = '/api/portal/chamber/users/export';
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (level) params.append('level', level);
        if (role) params.append('role', role);
        if (status) params.append('status', status);
        
        if (params.toString()) {
          url += '?' + params.toString();
        }

        window.open(url, '_blank');
      } catch (error) {
        console.error('导出失败:', error);
        alert('导出失败');
      }
    }

    // 基础问卷管理
    async function loadQuestionnaires(){
      try {
        const res = await fetch('/api/portal/chamber/questionnaires');
        const data = await res.json();
        const tbody = document.querySelector('#tblQuestionnaires tbody');
        tbody.innerHTML = '';
        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="5">${data.error || '加载失败'}</td></tr>`;
          return;
        }
        if (!data.questionnaires || data.questionnaires.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">暂无问卷数据</td></tr>';
          return;
        }
        data.questionnaires.forEach(q => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${q.name || '-'}</td>
            <td>${q.question_count || 0}</td>
            <td>${q.created_time || '-'}</td>
            <td><span class="tag ok">${q.status || '启用'}</span></td>
            <td>
              <button class="btn" onclick="alert('编辑问卷功能')">编辑</button>
              <button class="btn dl" onclick="alert('预览问卷功能')">预览</button>
              <button class="btn no" onclick="alert('删除问卷功能')">删除</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('加载问卷失败:', error);
        document.querySelector('#tblQuestionnaires tbody').innerHTML = '<tr><td colspan="5" style="color:#ef4444;">加载失败</td></tr>';
      }
    }

    // 专家管理函数
    async function loadExpertsTable(){
      const kw = document.getElementById('expKeyword').value.trim();
      const url = kw? `/api/portal/chamber/experts?q=${encodeURIComponent(kw)}` : '/api/portal/chamber/experts';
      const res = await fetch(url); const data = await res.json();
      const tb = document.querySelector('#tblExperts tbody'); tb.innerHTML='';
      (data.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.name}</td><td>${it.region||''}</td><td>${it.province||''}</td><td>${it.industry||''}</td><td>${it.level||''}</td><td>${it.phone||''}</td><td>${it.email||''}</td><td>${it.org||''}</td><td>${it.skills||''}</td>
        <td><button class='btn' onclick='editExp("${it.id}")'>编辑</button> <button class='btn no' onclick='delExp("${it.id}")'>删除</button></td>`;
        tb.appendChild(tr);
      })
    }
    function resetExpForm(){ ['expId','expName','expRegion','expProvince','expIndustry','expPhone','expEmail','expOrg','expSkills'].forEach(id=>document.getElementById(id).value=''); document.getElementById('expLevel').value='county'; }
    async function saveExpert(){
      const body={id:document.getElementById('expId').value||undefined,name:expName.value.trim(),region:expRegion.value.trim(),province:expProvince.value.trim(),industry:expIndustry.value.trim(),level:expLevel.value,phone:expPhone.value.trim(),email:expEmail.value.trim(),org:expOrg.value.trim(),skills:expSkills.value.trim()};
      const res = await fetch('/api/portal/chamber/experts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data = await res.json(); if(!data.success){alert(data.error||'保存失败');return;} resetExpForm(); loadExpertsTable(); }
    async function editExp(id){
      const res = await fetch('/api/portal/chamber/experts'); const data = await res.json(); const it=(data.items||[]).find(x=>x.id===id); if(!it)return; expId.value=it.id; expName.value=it.name||''; expRegion.value=it.region||''; expProvince.value=it.province||''; expIndustry.value=it.industry||''; expLevel.value=it.level||'county'; expPhone.value=it.phone||''; expEmail.value=it.email||''; expOrg.value=it.org||''; expSkills.value=it.skills||'';
    }
    async function delExp(id){ if(!confirm('确定删除?'))return; const res=await fetch(`/api/portal/chamber/experts/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadExpertsTable(); }

    // 专家自评详情
    async function loadExpertSelf(){
      const name = document.getElementById('selSelfExp').value;
      const res = await fetch(`/api/portal/chamber/expert-self?expert=${encodeURIComponent(name)}`);
      const data = await res.json();
      const tb = document.querySelector('#tblExpertSelf tbody');
      tb.innerHTML = '';
      if(!data.success){ tb.innerHTML = `<tr><td colspan="4" style="color:#ef4444;">${data.error||'加载失败'}</td></tr>`; return; }
      (data.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.time_text}</td><td>${it.score_pct.toFixed(1)}</td><td>${it.level}</td><td>${it.excel_file}</td>`;
        tb.appendChild(tr);
      })
    }

    // 专家评级管理
    async function doExpertRate(){
      const name = document.getElementById('selRateExp').value;
      const to_level = document.getElementById('selRateTo').value;
      const res = await fetch('/api/portal/chamber/expert-rate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({expert:name,to_level:to_level})});
      const data = await res.json();
      if(!data.success){alert(data.error||'操作失败');return;}
      alert('评级成功');
      loadExpertRate();
    }
    async function loadExpertRate(){
      const name = document.getElementById('selRateExp').value;
      if(!name){rateInfo.textContent='请选择专家';return;}
      const res = await fetch(`/api/portal/chamber/expert-rate?expert=${encodeURIComponent(name)}`);
      const data = await res.json();
      if(!data.success){rateInfo.textContent=data.error||'加载失败';return;}
      const d = data.data;
      rateInfo.innerHTML = `当前等级：<b>${d.level}</b>，可辅导范围：<b>${d.scope}</b>`;
    }

    // 专家辅导详情
    async function loadExpertTutoring(){
      const name = document.getElementById('selTutExp').value;
      const res = await fetch(`/api/portal/chamber/expert-tutoring?expert=${encodeURIComponent(name)}`);
      const data = await res.json();
      const tb = document.querySelector('#tblExpertTutoring tbody');
      tb.innerHTML = '';
      if(!data.success){tb.innerHTML = `<tr><td colspan="3" style="color:#ef4444;">${data.error||'加载失败'}</td></tr>`;return;}
      (data.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.time}</td><td>${it.enterprise}</td><td>${it.content}</td>`;
        tb.appendChild(tr);
      })
    }

    // 企业对专家评价
    async function loadExpertEvals(){
      const name = document.getElementById('selEvalExp').value;
      const res = await fetch(`/api/portal/chamber/expert-evaluations?expert=${encodeURIComponent(name)}`);
      const data = await res.json();
      const tb = document.querySelector('#tblExpertEvals tbody');
      tb.innerHTML = '';
      if(!data.success){tb.innerHTML = `<tr><td colspan="4" style="color:#ef4444;">${data.error||'加载失败'}</td></tr>`;return;}
      (data.items||[]).forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.time}</td><td>${it.enterprise}</td><td>${it.score}</td><td>${it.comment}</td>`;
        tb.appendChild(tr);
      })
    }
    async function addExpertEval(){
      const expert = document.getElementById('selEvalExp').value;
      const enterprise = document.getElementById('evEnterprise').value.trim();
      const score = document.getElementById('evScore').value.trim();
      const comment = document.getElementById('evComment').value.trim();
      if(!expert || !enterprise || !score){alert('请填写完整信息');return;}
      const res = await fetch('/api/portal/chamber/expert-evaluations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({expert,enterprise,score:parseFloat(score),comment})});
      const data = await res.json();
      if(!data.success){alert(data.error||'添加失败');return;}
      document.getElementById('evEnterprise').value = '';
      document.getElementById('evScore').value = '';
      document.getElementById('evComment').value = '';
      loadExpertEvals();
    }

    // 填充专家下拉
    async function fillExpertSelects(){
      const res = await fetch('/api/portal/chamber/experts');
      const data = await res.json();
      const opts = (data.items||[]).map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
      ['selSelfExp','selRateExp','selTutExp','selEvalExp'].forEach(id=>{
        const el = document.getElementById(id); if(el){ el.innerHTML = opts; }
      });
    }

    // —— 问卷/指标/规则 前端逻辑 ——
    // 指标树
    async function loadIndicatorsTree(){
      const type = document.getElementById('indicatorTypeFilter').value;
      const treeWrap = document.getElementById('indicatorTree');
      treeWrap.innerHTML = '<div class="muted">加载中...</div>';
      try{
        const url = type? `/api/portal/chamber/indicators/tree?type=${encodeURIComponent(type)}` : '/api/portal/chamber/indicators/tree';
        const res = await fetch(url);
        const data = await res.json();
        if(!data.success){ treeWrap.innerHTML = `<div style='color:#ef4444;'>${data.error||'加载失败'}</div>`; return; }
        const nodes = data.data?.indicators || [];
        treeWrap.innerHTML = renderIndicatorNodes(nodes);
      }catch(e){ treeWrap.innerHTML = `<div style='color:#ef4444;'>加载失败</div>`; }
    }
    function renderIndicatorNodes(nodes){
      if(!nodes || nodes.length===0) return '<div class="muted">暂无指标</div>';
      const render = (list)=>{
        return `<ul style="list-style:none;padding-left:16px;">` + list.map(n=>{
          return `<li style="margin:6px 0;">
            <b>${n.code||''}</b> ${n.name||''}
            <span class="muted">[L${n.level||''} ${n.type||''} 权重:${n.weight??'-'}]</span>
            <button class="btn" style="padding:2px 8px;margin-left:6px;" onclick="editIndicator('${n.id}')">编辑</button>
            <button class="btn no" style="padding:2px 8px;" onclick="deleteIndicator('${n.id}')">删除</button>
            ${n.children&&n.children.length? render(n.children): ''}
          </li>`;
        }).join('') + `</ul>`;
      };
      return render(nodes);
    }
    function showIndicatorModal(ind){
      document.getElementById('modalTitleText').textContent = ind? '编辑指标':'新增指标';
      const body = document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='indCode' class='remark' placeholder='指标代码*' value='${ind?.code||''}'/>
          <input id='indName' class='remark' placeholder='指标名称*' value='${ind?.name||''}'/>
          <input id='indLevel' class='remark' placeholder='等级(1/2/3)*' value='${ind?.level||''}'/>
          <input id='indParent' class='remark' placeholder='父ID(可空)' value='${ind?.parent_id||''}'/>
        </div>
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <select id='indType' class='remark'>
            <option ${!ind?.type? 'selected':''} value=''>类型(可选)</option>
            <option ${ind?.type==='基础类'?'selected':''} value='基础类'>基础类</option>
            <option ${ind?.type==='拔高类'?'selected':''} value='拔高类'>拔高类</option>
            <option ${ind?.type==='创新类'?'selected':''} value='创新类'>创新类</option>
            <option ${ind?.type==='责任类'?'selected':''} value='责任类'>责任类</option>
            <option ${ind?.type==='其他类'?'selected':''} value='其他类'>其他类</option>
          </select>
          <input id='indWeight' class='remark' placeholder='权重(0-1)' value='${ind?.weight??''}'/>
          <input id='indSort' class='remark' placeholder='排序(数字)' value='${ind?.sort_order??''}'/>
          <select id='indStatus' class='remark'>
            <option ${!ind||ind?.status==='active'?'selected':''} value='active'>启用</option>
            <option ${ind?.status==='inactive'?'selected':''} value='inactive'>停用</option>
          </select>
        </div>
        <textarea id='indDesc' class='remark' style='width:100%;height:100px' placeholder='描述'>${ind?.description||''}</textarea>
      `;
      const saveBtn = document.getElementById('modalSaveBtn');
      saveBtn.onclick = async ()=>{
        const payload={
          code: document.getElementById('indCode').value.trim(),
          name: document.getElementById('indName').value.trim(),
          level: parseInt(document.getElementById('indLevel').value.trim(),10),
          parent_id: document.getElementById('indParent').value.trim()||null,
          type: document.getElementById('indType').value||null,
          weight: document.getElementById('indWeight').value? parseFloat(document.getElementById('indWeight').value): null,
          sort_order: document.getElementById('indSort').value? parseInt(document.getElementById('indSort').value,10): null,
          status: document.getElementById('indStatus').value,
          description: document.getElementById('indDesc').value.trim()
        };
        if(!payload.code||!payload.name||![1,2,3].includes(payload.level)){ alert('请填写必填项：代码/名称/等级'); return; }
        const method = ind? 'PUT':'POST';
        const url = ind? `/api/portal/chamber/indicators/${ind.id}`: '/api/portal/chamber/indicators';
        const res = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await res.json();
        if(!data.success){ alert(data.error||'保存失败'); return; }
        closeModal(); loadIndicatorsTree();
      };
      openModal();
    }
    async function editIndicator(id){
      const res = await fetch(`/api/portal/chamber/indicators/${id}`);
      const data = await res.json();
      if(!data.success){ alert(data.error||'加载失败'); return; }
      showIndicatorModal(data.data);
    }
    async function deleteIndicator(id){ if(!confirm('确定删除该指标及其子项？'))return; const res=await fetch(`/api/portal/chamber/indicators/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadIndicatorsTree(); }

    // 评分规则
    async function loadScoringRules(){
      const ind = document.getElementById('ruleIndicatorId').value.trim();
      const lvl = document.getElementById('ruleLevelFilter').value;
      let url = '/api/portal/chamber/scoring-rules';
      const qs = new URLSearchParams();
      if(ind) qs.append('indicator_id', ind);
      if(lvl) qs.append('level', lvl);
      if(Array.from(qs).length) url += '?' + qs.toString();
      const res = await fetch(url); const data = await res.json();
      const tb = document.querySelector('#tblScoringRules tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan='6' style='color:#ef4444;'>${data.error||'加载失败'}</td></tr>`; return; }
      const rows = data.data?.rules||[];
      if(rows.length===0){ tb.innerHTML = `<tr><td colspan='6' class='muted'>暂无数据</td></tr>`; return; }
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.indicator_id}</td><td>${r.level}</td><td>${r.score_min||0}-${r.score_max||100}</td><td>${r.updated_at||'-'}</td>
        <td><button class='btn' onclick="editRule('${r.id}')">编辑</button> <button class='btn no' onclick="deleteRule('${r.id}')">删除</button></td>`;
        tb.appendChild(tr);
      });
    }
    function showRuleModal(rule){
      document.getElementById('modalTitleText').textContent = rule? '编辑规则':'新增规则';
      const body = document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='ruleIndicator' class='remark' placeholder='指标ID*' value='${rule?.indicator_id||''}'/>
          <select id='ruleLevel' class='remark'>
            <option ${rule?.level==='初级'?'selected':''} value='初级'>初级</option>
            <option ${rule?.level==='中级'?'selected':''} value='中级'>中级</option>
            <option ${rule?.level==='高级'?'selected':''} value='高级'>高级</option>
          </select>
          <input id='ruleMin' class='remark' placeholder='最小分(默认0)' value='${rule?.score_min??''}'/>
          <input id='ruleMax' class='remark' placeholder='最大分(默认100)' value='${rule?.score_max??''}'/>
        </div>
        <textarea id='ruleCriteria' class='remark' style='width:100%;height:140px' placeholder='评分标准(JSON数组)'>${rule?.criteria? JSON.stringify(rule.criteria,null,2): ''}</textarea>
      `;
      const saveBtn = document.getElementById('modalSaveBtn');
      saveBtn.onclick = async ()=>{
        let criteria=null; const txt=document.getElementById('ruleCriteria').value.trim();
        if(txt){ try{ criteria = JSON.parse(txt);}catch(e){ alert('评分标准需为JSON'); return; } }
        const payload={
          indicator_id: document.getElementById('ruleIndicator').value.trim(),
          level: document.getElementById('ruleLevel').value,
          score_min: document.getElementById('ruleMin').value? parseInt(document.getElementById('ruleMin').value,10): 0,
          score_max: document.getElementById('ruleMax').value? parseInt(document.getElementById('ruleMax').value,10): 100,
          criteria
        };
        if(!payload.indicator_id){ alert('指标ID必填'); return; }
        const method = rule? 'PUT':'POST';
        const url = rule? `/api/portal/chamber/scoring-rules/${rule.id}`: '/api/portal/chamber/scoring-rules';
        const res = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await res.json(); if(!data.success){ alert(data.error||'保存失败'); return; }
        closeModal(); loadScoringRules();
      };
      openModal();
    }
    async function editRule(id){ const res=await fetch(`/api/portal/chamber/scoring-rules/${id}`); const data=await res.json(); if(!data.success){alert(data.error||'加载失败');return;} showRuleModal(data.data); }
    async function deleteRule(id){ if(!confirm('确定删除该规则？'))return; const res=await fetch(`/api/portal/chamber/scoring-rules/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadScoringRules(); }

    // 企业问卷
    async function loadEnterpriseSurveys(){
      const lvl=document.getElementById('entSurveyLevel').value; const st=document.getElementById('entSurveyStatus').value;
      let url='/api/portal/chamber/enterprise-surveys'; const qs=new URLSearchParams(); if(lvl)qs.append('level',lvl); if(st)qs.append('status',st); if(Array.from(qs).length)url+='?'+qs.toString();
      const res=await fetch(url); const data=await res.json(); const tb=document.querySelector('#tblEnterpriseSurveys tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan='6' style='color:#ef4444;'>${data.error||'加载失败'}</td></tr>`; return; }
      const rows=data.data?.surveys||[]; if(rows.length===0){ tb.innerHTML = `<tr><td colspan='6' class='muted'>暂无数据</td></tr>`; return; }
      rows.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.level}</td><td>${s.status==='active'?'<span class=tag ok>使用</span>':'<span class=tag no>关闭</span>'}</td><td>${s.total_questions||0}</td><td>${s.updated_at||'-'}</td>
      <td><button class='btn' onclick="editEnterpriseSurvey('${s.id}')">编辑</button> <button class='btn gray' onclick="toggleEnterpriseSurvey('${s.id}','${s.status==='active'?'inactive':'active'}')">${s.status==='active'?'关闭':'使用'}</button> <button class='btn no' onclick="deleteEnterpriseSurvey('${s.id}')">删除</button></td>`; tb.appendChild(tr); });
    }
    function showEnterpriseSurveyModal(s){
      document.getElementById('modalTitleText').textContent = s? '编辑企业问卷':'新建企业问卷';
      const body=document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='esName' class='remark' placeholder='问卷名称*' value='${s?.name||''}'/>
          <select id='esLevel' class='remark'>
            <option ${s?.level==='初级'?'selected':''} value='初级'>初级</option>
            <option ${s?.level==='中级'?'selected':''} value='中级'>中级</option>
            <option ${s?.level==='高级'?'selected':''} value='高级'>高级</option>
          </select>
          <select id='esStatus' class='remark'>
            <option ${!s||s?.status==='active'?'selected':''} value='active'>使用</option>
            <option ${s?.status==='inactive'?'selected':''} value='inactive'>关闭</option>
          </select>
        </div>
        <textarea id='esDesc' class='remark' style='width:100%;height:80px' placeholder='描述'>${s?.description||''}</textarea>
        <div class='muted'>问题编辑与指标题对接可在后续版本细化，此处先提供基本问卷元数据CRUD。</div>
      `;
      const saveBtn=document.getElementById('modalSaveBtn');
      saveBtn.onclick = async()=>{
        const payload={name:esName.value.trim(), level:esLevel.value, status:esStatus.value, description:esDesc.value.trim()};
        if(!payload.name){ alert('问卷名称必填'); return; }
        const method=s? 'PUT':'POST'; const url=s? `/api/portal/chamber/enterprise-surveys/${s.id}`:'/api/portal/chamber/enterprise-surveys';
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;}
        closeModal(); loadEnterpriseSurveys();
      };
      openModal();
    }
    async function editEnterpriseSurvey(id){ const res=await fetch(`/api/portal/chamber/enterprise-surveys/${id}`); const data=await res.json(); if(!data.success){alert(data.error||'加载失败');return;} showEnterpriseSurveyModal(data.data); }
    async function toggleEnterpriseSurvey(id,to){ const res=await fetch(`/api/portal/chamber/enterprise-surveys/${id}/status`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:to})}); const data=await res.json(); if(!data.success){alert(data.error||'操作失败');return;} loadEnterpriseSurveys(); }
    async function deleteEnterpriseSurvey(id){ if(!confirm('确定删除该问卷？'))return; const res=await fetch(`/api/portal/chamber/enterprise-surveys/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadEnterpriseSurveys(); }

    // 专家问卷
    async function loadExpertSurveys(){
      const typ=document.getElementById('expertTypeFilter').value.trim(); const st=document.getElementById('expSurveyStatus').value; let url='/api/portal/chamber/expert-surveys'; const qs=new URLSearchParams(); if(typ)qs.append('expert_type',typ); if(st)qs.append('status',st); if(Array.from(qs).length)url+='?'+qs.toString();
      const res=await fetch(url); const data=await res.json(); const tb=document.querySelector('#tblExpertSurveys tbody'); tb.innerHTML='';
      if(!data.success){ tb.innerHTML = `<tr><td colspan='6' style='color:#ef4444;'>${data.error||'加载失败'}</td></tr>`; return; }
      const rows=data.data?.surveys||[]; if(rows.length===0){ tb.innerHTML = `<tr><td colspan='6' class='muted'>暂无数据</td></tr>`; return; }
      rows.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.expert_type}</td><td>${s.status==='active'?'<span class=tag ok>使用</span>':'<span class=tag no>关闭</span>'}</td><td>${s.total_questions||0}</td><td>${s.updated_at||'-'}</td>
      <td><button class='btn' onclick="editExpertSurvey('${s.id}')">编辑</button> <button class='btn gray' onclick="toggleExpertSurvey('${s.id}','${s.status==='active'?'inactive':'active'}')">${s.status==='active'?'关闭':'使用'}</button> <button class='btn no' onclick="deleteExpertSurvey('${s.id}')">删除</button></td>`; tb.appendChild(tr); });
    }
    function showExpertSurveyModal(s){
      document.getElementById('modalTitleText').textContent = s? '编辑专家问卷':'新建专家问卷';
      const body=document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='xsName' class='remark' placeholder='问卷名称*' value='${s?.name||''}'/>
          <input id='xsType' class='remark' placeholder='专家类型*(如: 技术专家)' value='${s?.expert_type||''}'/>
          <select id='xsStatus' class='remark'>
            <option ${!s||s?.status==='active'?'selected':''} value='active'>使用</option>
            <option ${s?.status==='inactive'?'selected':''} value='inactive'>关闭</option>
          </select>
        </div>
        <textarea id='xsDesc' class='remark' style='width:100%;height:80px' placeholder='描述'>${s?.description||''}</textarea>
        <div class='muted'>问题编辑与指标题对接可在后续版本细化，此处先提供基本问卷元数据CRUD。</div>
      `;
      const saveBtn=document.getElementById('modalSaveBtn');
      saveBtn.onclick = async()=>{
        const payload={name:xsName.value.trim(), expert_type:xsType.value.trim(), status:xsStatus.value, description:xsDesc.value.trim()};
        if(!payload.name||!payload.expert_type){ alert('名称与专家类型必填'); return; }
        const method=s? 'PUT':'POST'; const url=s? `/api/portal/chamber/expert-surveys/${s.id}`:'/api/portal/chamber/expert-surveys';
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;}
        closeModal(); loadExpertSurveys();
      };
      openModal();
    }
    async function editExpertSurvey(id){ const res=await fetch(`/api/portal/chamber/expert-surveys/${id}`); const data=await res.json(); if(!data.success){alert(data.error||'加载失败');return;} showExpertSurveyModal(data.data); }
    async function toggleExpertSurvey(id,to){ const res=await fetch(`/api/portal/chamber/expert-surveys/${id}/status`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:to})}); const data=await res.json(); if(!data.success){alert(data.error||'操作失败');return;} loadExpertSurveys(); }
    async function deleteExpertSurvey(id){ if(!confirm('确定删除该问卷？'))return; const res=await fetch(`/api/portal/chamber/expert-surveys/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadExpertSurveys(); }

    // 通用模态框
    function openModal(){ document.getElementById('modalMask').style.display='flex'; }
    function closeModal(){ document.getElementById('modalMask').style.display='none'; document.getElementById('modalBody').innerHTML=''; }

    // 新建指标入口
    function showIndicatorModalNew(){ showIndicatorModal(null); }

    // 平台基础功能管理 —— 角色、菜单、权限、邮箱、短信
    function tagStatus(s){ if(s==='active') return '<span class="tag ok">启用</span>'; if(s==='inactive') return '<span class="tag no">停用</span>'; return `<span class="tag warn">${s||'-'}</span>`; }

    // 角色管理
    async function loadRoles(){
      const kw = document.getElementById('roleKeyword').value.trim();
      let url = '/api/platform/roles'; if(kw) url += `?keyword=${encodeURIComponent(kw)}`;
      try{
        const res = await fetch(url); const data = await res.json();
        const tb = document.querySelector('#tblRoles tbody'); tb.innerHTML='';
        if(!data.success){ tb.innerHTML = `<tr><td colspan='6' style='color:#ef4444;'>${data.error||'加载失败'}</td></tr>`; return; }
        const rows = data.data?.roles || data.roles || [];
        if(rows.length===0){ tb.innerHTML = `<tr><td colspan='6' class='muted'>暂无数据</td></tr>`; return; }
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.name}</td><td>${r.key}</td><td>${r.description||''}</td><td>${tagStatus(r.status)}</td><td>${r.created_at||'-'}</td>
          <td><button class='btn' onclick="editRole('${r.id}')">编辑</button> <button class='btn no' onclick="deleteRole('${r.id}')">删除</button></td>`;
          tb.appendChild(tr);
        });
      }catch(e){ document.querySelector('#tblRoles tbody').innerHTML = `<tr><td colspan='6' style='color:#ef4444;'>加载失败</td></tr>`; }
    }
    function showRoleModal(role){
      document.getElementById('modalTitleText').textContent = role? '编辑角色':'新增角色';
      const body=document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='roleName' class='remark' placeholder='角色名称*' value='${role?.name||''}'/>
          <input id='roleKey' class='remark' placeholder='角色键*(唯一, 如: admin)' value='${role?.key||''}' ${role? 'disabled':''}/>
          <select id='roleStatus' class='remark'>
            <option ${!role||role?.status==='active'?'selected':''} value='active'>启用</option>
            <option ${role?.status==='inactive'?'selected':''} value='inactive'>停用</option>
          </select>
        </div>
        <textarea id='roleDesc' class='remark' style='width:100%;height:80px' placeholder='描述'>${role?.description||''}</textarea>
      `;
      const saveBtn=document.getElementById('modalSaveBtn');
      saveBtn.onclick = async()=>{
        const payload={name:roleName.value.trim(), key:roleKey.value.trim(), status:roleStatus.value, description:roleDesc.value.trim()};
        if(!payload.name||!payload.key){ alert('请填写角色名称与角色键'); return; }
        const method=role? 'PUT':'POST'; const url= role? `/api/platform/roles/${role.id}`:'/api/platform/roles';
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;}
        closeModal(); loadRoles();
      };
      openModal();
    }
    async function editRole(id){ const res=await fetch(`/api/platform/roles/${id}`); const data=await res.json(); if(!data.success){alert(data.error||'加载失败');return;} showRoleModal(data.data||data.role); }
    async function deleteRole(id){ if(!confirm('确定删除该角色？')) return; const res=await fetch(`/api/platform/roles/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadRoles(); }

    // 菜单管理
    async function loadMenus(){
      const kw=document.getElementById('menuKeyword').value.trim(); let url='/api/platform/menus'; if(kw) url+=`?keyword=${encodeURIComponent(kw)}`;
      try{
        const res=await fetch(url); const data=await res.json(); const tb=document.querySelector('#tblMenus tbody'); tb.innerHTML='';
        if(!data.success){ tb.innerHTML = `<tr><td colspan='7' style='color:#ef4444;'>${data.error||'加载失败'}</td></tr>`; return; }
        const rows=data.data?.menus||data.menus||[]; if(rows.length===0){ tb.innerHTML = `<tr><td colspan='7' class='muted'>暂无数据</td></tr>`; return; }
        rows.forEach(m=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${m.name}</td><td>${m.key||''}${m.path? ' / '+m.path:''}</td><td>${m.parent_key||''}</td><td>${m.type||''}</td><td>${m.sort||0}</td><td>${tagStatus(m.status)}</td>
        <td><button class='btn' onclick="editMenu('${m.id}')">编辑</button> <button class='btn no' onclick="deleteMenu('${m.id}')">删除</button></td>`; tb.appendChild(tr); });
      }catch(e){ document.querySelector('#tblMenus tbody').innerHTML = `<tr><td colspan='7' style='color:#ef4444;'>加载失败</td></tr>`; }
    }
    function showMenuModal(menu){
      document.getElementById('modalTitleText').textContent = menu? '编辑菜单':'新增菜单';
      const body=document.getElementById('modalBody');
      body.innerHTML = `
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <input id='menuName' class='remark' placeholder='名称*' value='${menu?.name||''}'/>
          <input id='menuKey' class='remark' placeholder='键*(唯一)' value='${menu?.key||''}' ${menu? 'disabled':''}/>
          <input id='menuPath' class='remark' placeholder='路由/路径(可选)' value='${menu?.path||''}'/>
          <input id='menuParent' class='remark' placeholder='父键(可选)' value='${menu?.parent_key||''}'/>
        </div>
        <div class='toolbar' style='margin:0 0 8px 0;'>
          <select id='menuType' class='remark'>
            <option ${menu?.type==='directory'?'selected':''} value='directory'>目录</option>
            <option ${!menu||menu?.type==='menu'?'selected':''} value='menu'>菜单</option>
            <option ${menu?.type==='button'?'selected':''} value='button'>按钮</option>
          </select>
          <input id='menuSort' class='remark' placeholder='排序' value='${menu?.sort??0}'/>
          <select id='menuStatus' class='remark'>
            <option ${!menu||menu?.status==='active'?'selected':''} value='active'>启用</option>
            <option ${menu?.status==='inactive'?'selected':''} value='inactive'>停用</option>
          </select>
        </div>
      `;
      const saveBtn=document.getElementById('modalSaveBtn');
      saveBtn.onclick = async()=>{
        const payload={name:menuName.value.trim(), key:menuKey.value.trim(), path:menuPath.value.trim()||null, parent_key:menuParent.value.trim()||null, type:menuType.value, sort:parseInt(menuSort.value||'0',10), status:menuStatus.value};
        if(!payload.name||!payload.key){ alert('请填写名称与键'); return; }
        const method=menu? 'PUT':'POST'; const url= menu? `/api/platform/menus/${menu.id}`:'/api/platform/menus';
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;}
        closeModal(); loadMenus();
      };
      openModal();
    }
    async function editMenu(id){ const res=await fetch(`/api/platform/menus/${id}`); const data=await res.json(); if(!data.success){alert(data.error||'加载失败');return;} showMenuModal(data.data||data.menu); }
    async function deleteMenu(id){ if(!confirm('确定删除该菜单？')) return; const res=await fetch(`/api/platform/menus/${id}`,{method:'DELETE'}); const data=await res.json(); if(!data.success){alert(data.error||'删除失败');return;} loadMenus(); }

    // 权限管理
    async function initPermissionsTab(){ await fillRolesSelect(); document.getElementById('permMenus').innerHTML='<div class="muted">请选择角色后加载菜单树...</div>'; }
    async function fillRolesSelect(){
      const res=await fetch('/api/platform/roles'); const data=await res.json(); const sel=document.getElementById('permRoleSelect'); sel.innerHTML='';
      if(data.success){ (data.data?.roles||data.roles||[]).forEach(r=>{ const opt=document.createElement('option'); opt.value=r.id; opt.textContent=`${r.name} (${r.key})`; sel.appendChild(opt); }); }
    }
    async function loadPermissions(){
      const roleId=document.getElementById('permRoleSelect').value; if(!roleId){ document.getElementById('permMenus').innerHTML='<div class="muted">未选择角色</div>'; return; }
      const [treeRes, permRes] = await Promise.all([
        fetch('/api/platform/menus/tree'),
        fetch(`/api/platform/permissions?role_id=${encodeURIComponent(roleId)}`)
      ]);
      const treeData = await treeRes.json(); const permData = await permRes.json();
      if(!treeData.success){ document.getElementById('permMenus').innerHTML=`<div style='color:#ef4444;'>${treeData.error||'菜单树加载失败'}</div>`; return; }
      const assigned = new Set((permData.data?.menu_ids)||permData.menu_ids||[]);
      document.getElementById('permMenus').innerHTML = renderPermTree(treeData.data?.menus||treeData.menus||[], assigned);
    }
    function renderPermTree(nodes, assigned){
      const render = (list)=>{
        return `<ul style="list-style:none;padding-left:16px;">` + list.map(n=>{
          const checked = assigned.has(n.id)? 'checked':'';
          return `<li style="margin:4px 0;">
            <label style="display:flex;gap:8px;align-items:center;">
              <input type='checkbox' class='perm-item' data-id='${n.id}' ${checked}/>
              <span>${n.name} <span class='muted'>(${n.key||''})</span></span>
            </label>
            ${n.children&&n.children.length? render(n.children): ''}
          </li>`;
        }).join('') + `</ul>`;
      };
      return render(nodes);
    }
    async function saveRolePermissions(){
      const roleId=document.getElementById('permRoleSelect').value; if(!roleId){ alert('请选择角色'); return; }
      const ids=Array.from(document.querySelectorAll('#permMenus .perm-item:checked')).map(el=>el.dataset.id);
      const res=await fetch('/api/platform/permissions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role_id:roleId, menu_ids:ids})});
      const data=await res.json(); if(!data.success){ alert(data.error||'保存失败'); return; } alert('保存成功');
    }

    // 邮箱配置
    async function loadEmailConfig(){
      const res=await fetch('/api/platform/email-config'); const data=await res.json(); if(!data.success) return;
      smtpHost.value=data.data?.host||''; smtpPort.value=data.data?.port||''; smtpUser.value=data.data?.username||''; smtpFrom.value=data.data?.from||''; smtpSSL.checked=!!data.data?.ssl; smtpTLS.checked=!!data.data?.tls;
    }
    async function saveEmailConfig(){
      const payload={host:smtpHost.value.trim(), port:parseInt(smtpPort.value||'0',10), username:smtpUser.value.trim(), password:smtpPass.value.trim()||undefined, from:smtpFrom.value.trim()||undefined, ssl: smtpSSL.checked, tls: smtpTLS.checked};
      if(!payload.host||!payload.port||!payload.username){ alert('请填写SMTP服务器/端口/账号'); return; }
      const res=await fetch('/api/platform/email-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;} alert('保存成功'); smtpPass.value='';
    }
    async function testEmailConfig(){ const to=testEmailTo.value.trim(); if(!to){alert('请输入测试收件人');return;} const res=await fetch('/api/platform/email-config/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to})}); const data=await res.json(); alert(data.success?'测试邮件已发送':(data.error||'发送失败')); }

    // 短信网关
    async function loadSmsGateway(){ const res=await fetch('/api/platform/sms-gateway'); const data=await res.json(); if(!data.success) return; smsProvider.value=data.data?.provider||''; smsEndpoint.value=data.data?.endpoint||''; smsSign.value=data.data?.sign||''; smsTemplate.value=data.data?.template||''; smsKey.value=data.data?.access_key||''; smsSecret.value=''; smsStatus.value=data.data?.status||'inactive'; }
    async function saveSmsGateway(){ const payload={provider:smsProvider.value.trim(), endpoint:smsEndpoint.value.trim()||undefined, sign:smsSign.value.trim(), template:smsTemplate.value.trim(), access_key:smsKey.value.trim(), secret:smsSecret.value.trim()||undefined, status:smsStatus.value}; if(!payload.sign||!payload.template||!payload.access_key){ alert('请填写签名/模板ID/AccessKey'); return;} const res=await fetch('/api/platform/sms-gateway',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.success){alert(data.error||'保存失败');return;} alert('保存成功'); smsSecret.value=''; }
    async function testSmsGateway(){ const to=testSmsTo.value.trim(); if(!to){alert('请输入测试手机号');return;} const res=await fetch('/api/platform/sms-gateway/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to})}); const data=await res.json(); alert(data.success?'测试短信已发送':(data.error||'发送失败')); }

    // 初始加载
    switchTab('qualification');
  </script>
</body>
</html>
