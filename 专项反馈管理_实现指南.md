# 专项反馈管理系统 - 实现指南

## 一、系统概述

专项反馈管理系统用于对企业反馈的问题进行分类查看和深度分析，支持5种反馈类型和多维度的分析功能。

### 核心功能
- ✅ 反馈分类管理（5种类型，多个子分类）
- ✅ 反馈CRUD操作
- ✅ 多维度深度分析
- ✅ 关键指标统计
- ✅ 问题聚类分析
- ✅ 趋势预测
- ✅ 报告生成

---

## 二、数据库设计

### 2.1 核心表结构

#### special_feedbacks 表
```sql
CREATE TABLE special_feedbacks (
  id VARCHAR(36) PRIMARY KEY,
  enterprise_id VARCHAR(36),
  enterprise_name VARCHAR(100),
  
  -- 分类信息
  category VARCHAR(50) NOT NULL,
  subcategory VARCHAR(50),
  
  -- 内容
  title VARCHAR(200) NOT NULL,
  content TEXT,
  
  -- 附件
  attachments JSON,
  file_count INT DEFAULT 0,
  
  -- 状态
  status ENUM('draft', 'submitted', 'reviewing', 'approved', 'rejected'),
  rating INT,
  priority ENUM('low', 'medium', 'high', 'urgent'),
  
  -- 时间
  submitted_at TIMESTAMP,
  reviewed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 审核
  reviewer_id VARCHAR(36),
  reviewer_name VARCHAR(50),
  review_comment TEXT,
  
  -- 其他
  tags JSON,
  remark TEXT,
  
  INDEX idx_category (category),
  INDEX idx_status (status),
  INDEX idx_submitted_at (submitted_at)
);
```

#### feedback_analysis 表
```sql
CREATE TABLE feedback_analysis (
  id VARCHAR(36) PRIMARY KEY,
  feedback_id VARCHAR(36),
  dimension VARCHAR(50),
  metric_name VARCHAR(100),
  metric_value DECIMAL(10, 2),
  analysis_type VARCHAR(50),
  analysis_result TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_feedback_id (feedback_id),
  INDEX idx_dimension (dimension)
);
```

#### feedback_statistics 表
```sql
CREATE TABLE feedback_statistics (
  id VARCHAR(36) PRIMARY KEY,
  stat_date DATE,
  stat_type VARCHAR(50),
  total_count INT DEFAULT 0,
  category_breakdown JSON,
  status_breakdown JSON,
  rating_distribution JSON,
  trend_data JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_date_type (stat_date, stat_type)
);
```

---

## 三、反馈分类体系

### 3.1 分类映射表

```python
SUBCATEGORIES = {
    'typical_case': [
        '党建',
        '文化建设',
        '社会责任',
        '创新发展',
        '人才培养',
        '其他'
    ],
    'issue_feedback': [
        '经营问题',
        '管理问题',
        '技术问题',
        '其他问题'
    ],
    'chamber_feedback': [
        '政策建议',
        '服务评价',
        '合作建议',
        '其他反馈'
    ],
    'expert_feedback': [
        '技术评价',
        '管理评价',
        '发展评价',
        '其他评价'
    ],
    'material': [
        '财务报表',
        '荣誉证书',
        '项目成果',
        '其他材料'
    ]
}
```

---

## 四、API 接口

### 4.1 反馈管理接口

#### 获取反馈列表
```
GET /api/portal/chamber/feedbacks
Query Parameters:
  - page: 页码 (默认1)
  - limit: 每页数量 (默认20)
  - keyword: 搜索关键词
  - category: 反馈类型
  - status: 反馈状态
  - date_from: 开始日期
  - date_to: 结束日期

Response:
{
  "success": true,
  "data": {
    "total": 200,
    "page": 1,
    "limit": 20,
    "feedbacks": [
      {
        "id": "uuid",
        "category": "typical_case",
        "category_name": "典型案例",
        "subcategory": "党建",
        "title": "党建引领企业发展",
        "enterprise_name": "企业A",
        "status": "approved",
        "rating": 4,
        "submitted_at": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

#### 创建反馈
```
POST /api/portal/chamber/feedbacks
Body:
{
  "category": "typical_case",
  "subcategory": "党建",
  "title": "党建引领企业发展",
  "content": "详细内容",
  "enterprise_id": "ent_001",
  "enterprise_name": "企业A",
  "priority": "high",
  "attachments": ["file1.pdf"],
  "tags": ["党建", "发展"]
}
```

#### 更新反馈
```
PUT /api/portal/chamber/feedbacks/:id
Body:
{
  "title": "更新标题",
  "content": "更新内容",
  "status": "submitted",
  "rating": 4
}
```

#### 删除反馈
```
DELETE /api/portal/chamber/feedbacks/:id
```

### 4.2 分析接口

#### 分类分析
```
GET /api/portal/chamber/feedbacks/analysis/category
Query Parameters:
  - date_from: 开始日期
  - date_to: 结束日期

Response:
{
  "success": true,
  "data": {
    "total": 200,
    "categories": {
      "典型案例": 50,
      "问题反馈": 70,
      "工商联反馈": 40,
      "专家评价": 30,
      "佐证材料": 10
    },
    "percentage": {
      "典型案例": 25,
      "问题反馈": 35,
      "工商联反馈": 20,
      "专家评价": 15,
      "佐证材料": 5
    }
  }
}
```

#### 时间趋势
```
GET /api/portal/chamber/feedbacks/analysis/trend
Query Parameters:
  - date_from: 开始日期
  - date_to: 结束日期
  - period: day/week/month

Response:
{
  "success": true,
  "data": {
    "trend": [
      { "date": "2024-01-01", "count": 10 },
      { "date": "2024-01-02", "count": 15 }
    ]
  }
}
```

#### 评分分析
```
GET /api/portal/chamber/feedbacks/analysis/rating
Query Parameters:
  - date_from: 开始日期
  - date_to: 结束日期

Response:
{
  "success": true,
  "data": {
    "average_rating": 3.8,
    "distribution": {
      "5": 40,
      "4": 30,
      "3": 20,
      "2": 7,
      "1": 3
    }
  }
}
```

#### 关键指标
```
GET /api/portal/chamber/feedbacks/analysis/metrics
Query Parameters:
  - date_from: 开始日期
  - date_to: 结束日期

Response:
{
  "success": true,
  "data": {
    "total_feedbacks": 200,
    "average_rating": 3.8,
    "approval_rate": 0.85,
    "avg_processing_time": 3.5,
    "high_priority_ratio": 0.15
  }
}
```

#### 问题分析
```
GET /api/portal/chamber/feedbacks/analysis/issues
Query Parameters:
  - date_from: 开始日期
  - date_to: 结束日期

Response:
{
  "success": true,
  "data": {
    "total_issues": 70,
    "issues": [
      {
        "category": "经营问题",
        "count": 25,
        "percentage": 35
      }
    ]
  }
}
```

---

## 五、前端实现

### 5.1 反馈列表页面

```javascript
// 全局状态
let feedbackState = {
  currentPage: 1,
  pageSize: 20,
  total: 0,
  allFeedbacks: []
};

// 加载反馈列表
async function loadFeedbacks(){
  const keyword = document.getElementById('feedbackKeyword').value.trim();
  const category = document.getElementById('feedbackCategory').value;
  const status = document.getElementById('feedbackStatus').value;
  const dateFrom = document.getElementById('feedbackDateFrom').value;
  const dateTo = document.getElementById('feedbackDateTo').value;
  
  let url = `/api/portal/chamber/feedbacks?page=${feedbackState.currentPage}&limit=${feedbackState.pageSize}`;
  if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
  if (category) url += `&category=${category}`;
  if (status) url += `&status=${status}`;
  if (dateFrom) url += `&date_from=${dateFrom}`;
  if (dateTo) url += `&date_to=${dateTo}`;

  const res = await fetch(url);
  const data = await res.json();
  
  if (!data.success) {
    alert('加载失败');
    return;
  }

  feedbackState.total = data.data.total;
  feedbackState.allFeedbacks = data.data.feedbacks;

  const tbody = document.querySelector('#tblFeedbacks tbody');
  tbody.innerHTML = '';

  data.data.feedbacks.forEach(fb => {
    const tr = document.createElement('tr');
    const statusBadge = {
      'approved': '<span class="tag ok">已批准</span>',
      'rejected': '<span class="tag no">已驳回</span>',
      'reviewing': '<span class="tag warn">审核中</span>',
      'submitted': '<span class="tag warn">已提交</span>',
      'draft': '<span class="tag">草稿</span>'
    }[fb.status] || '-';

    tr.innerHTML = `
      <td>${fb.category_name}</td>
      <td>${fb.subcategory}</td>
      <td>${fb.title}</td>
      <td>${fb.enterprise_name}</td>
      <td>${statusBadge}</td>
      <td>${fb.rating || '-'}</td>
      <td>${fb.submitted_at ? new Date(fb.submitted_at).toLocaleDateString() : '-'}</td>
      <td>
        <button class="btn" onclick="viewFeedback('${fb.id}')">查看</button>
        <button class="btn" onclick="editFeedback('${fb.id}')">编辑</button>
        <button class="btn no" onclick="deleteFeedback('${fb.id}')">删除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  updateFeedbackPagination();
}

// 更新分页
function updateFeedbackPagination(){
  const totalPages = Math.ceil(feedbackState.total / feedbackState.pageSize);
  document.getElementById('feedbackPageInfo').textContent = 
    `第 ${feedbackState.currentPage} 页 / 共 ${totalPages} 页 (总计 ${feedbackState.total} 条)`;
}

// 上一页
function feedbackPrevPage(){
  if (feedbackState.currentPage > 1) {
    feedbackState.currentPage--;
    loadFeedbacks();
  }
}

// 下一页
function feedbackNextPage(){
  const totalPages = Math.ceil(feedbackState.total / feedbackState.pageSize);
  if (feedbackState.currentPage < totalPages) {
    feedbackState.currentPage++;
    loadFeedbacks();
  }
}
```

### 5.2 深度分析页面

```javascript
// 加载分析数据
async function loadFeedbackAnalysis(){
  const dateFrom = document.getElementById('analysisDateFrom').value;
  const dateTo = document.getElementById('analysisDateTo').value;

  // 加载关键指标
  const metricsRes = await fetch(
    `/api/portal/chamber/feedbacks/analysis/metrics?date_from=${dateFrom}&date_to=${dateTo}`
  );
  const metricsData = await metricsRes.json();
  
  if (metricsData.success) {
    document.getElementById('metricTotal').textContent = metricsData.data.total_feedbacks;
    document.getElementById('metricAvgRating').textContent = metricsData.data.average_rating;
    document.getElementById('metricApprovalRate').textContent = 
      (metricsData.data.approval_rate * 100).toFixed(0) + '%';
    document.getElementById('metricAvgTime').textContent = 
      metricsData.data.avg_processing_time.toFixed(1) + '天';
  }

  // 加载分类分析
  const categoryRes = await fetch(
    `/api/portal/chamber/feedbacks/analysis/category?date_from=${dateFrom}&date_to=${dateTo}`
  );
  const categoryData = await categoryRes.json();
  
  if (categoryData.success) {
    drawCategoryChart(categoryData.data);
  }

  // 加载评分分析
  const ratingRes = await fetch(
    `/api/portal/chamber/feedbacks/analysis/rating?date_from=${dateFrom}&date_to=${dateTo}`
  );
  const ratingData = await ratingRes.json();
  
  if (ratingData.success) {
    drawRatingChart(ratingData.data);
  }

  // 加载趋势分析
  const trendRes = await fetch(
    `/api/portal/chamber/feedbacks/analysis/trend?date_from=${dateFrom}&date_to=${dateTo}&period=day`
  );
  const trendData = await trendRes.json();
  
  if (trendData.success) {
    drawTrendChart(trendData.data);
  }

  // 加载问题分析
  const issuesRes = await fetch(
    `/api/portal/chamber/feedbacks/analysis/issues?date_from=${dateFrom}&date_to=${dateTo}`
  );
  const issuesData = await issuesRes.json();
  
  if (issuesData.success) {
    loadIssueAnalysis(issuesData.data);
  }
}

// 绘制分类分析图表
function drawCategoryChart(data){
  const ctx = document.getElementById('chartCategory').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(data.categories),
      datasets: [{
        data: Object.values(data.categories),
        backgroundColor: [
          '#4338ca',
          '#0ea5e9',
          '#16a34a',
          '#f59e0b',
          '#ef4444'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

// 绘制评分分析图表
function drawRatingChart(data){
  const ctx = document.getElementById('chartRating').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['5星', '4星', '3星', '2星', '1星'],
      datasets: [{
        label: '数量',
        data: [
          data.distribution['5'],
          data.distribution['4'],
          data.distribution['3'],
          data.distribution['2'],
          data.distribution['1']
        ],
        backgroundColor: '#4338ca'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// 绘制趋势图表
function drawTrendChart(data){
  const ctx = document.getElementById('chartTrend').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.trend.map(t => t.date),
      datasets: [{
        label: '反馈数量',
        data: data.trend.map(t => t.count),
        borderColor: '#4338ca',
        backgroundColor: 'rgba(67, 56, 202, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// 加载问题分析
function loadIssueAnalysis(data){
  const tbody = document.querySelector('#tblIssueAnalysis tbody');
  tbody.innerHTML = '';

  data.issues.forEach(issue => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${issue.category}</td>
      <td>${issue.count}</td>
      <td>${issue.percentage}%</td>
      <td>
        <button class="btn" onclick="viewIssueDetails('${issue.category}')">查看详情</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
```

---

## 六、深度分析功能详解

### 6.1 分类分析
- 统计各类型反馈的数量和占比
- 支持按时间范围筛选
- 可视化展示为饼图或柱状图

### 6.2 时间趋势分析
- 支持按日、周、月统计
- 显示反馈提交趋势
- 可用于预测未来趋势

### 6.3 评分分析
- 计算平均评分
- 显示评分分布
- 识别高分和低分反馈

### 6.4 问题聚类分析
- 按问题类型分类
- 统计各类问题数量
- 识别主要问题

### 6.5 关键指标分析
- 总反馈数
- 平均评分
- 批准率
- 平均处理时间
- 高优先级比例

---

## 七、实现清单

### Phase 1（必须）
- [ ] 数据库表创建
- [ ] 反馈CRUD接口
- [ ] 反馈列表页面
- [ ] 新增/编辑页面
- [ ] 分类分析接口

### Phase 2（重要）
- [ ] 时间趋势分析
- [ ] 评分分析
- [ ] 问题分析
- [ ] 关键指标分析
- [ ] 分析图表展示

### Phase 3（优化）
- [ ] 报告生成
- [ ] 数据导出
- [ ] 对标分析
- [ ] 趋势预测

### Phase 4（扩展）
- [ ] 移动端支持
- [ ] API文档
- [ ] 单元测试
- [ ] 性能优化


