# 双门户系统功能分离方案

**目标**: 将系统分离为工商联门户和企业门户两个独立模块

---

## 🏢 门户一：工商联用户门户

### 登录信息
```
角色: chamber_of_commerce
账号: chamber / chamber123
访问: http://localhost:5000/portal/chamber
```

### 核心功能模块

#### 1. 评价指标管理 ⭐
```
功能:
✅ 指标体系存储（Excel格式）
✅ 指标增删改查
✅ 指标版本管理
✅ 指标导入导出

实现状态:
✅ 已有指标管理蓝图: indicator_management/
✅ 已有管理页面: /admin/indicator-management
✅ 已有API接口: /api/indicators/*

需要调整:
- 将管理页面移到工商联门户
- 添加权限控制（仅工商联可访问）
```

#### 2. 问卷生成管理 ⭐
```
功能:
✅ 根据评价指标自动生成问卷
✅ 三级问卷生成（初级/中级/高级）
✅ 问卷预览
✅ 问卷发布

实现状态:
✅ 已有生成器: survey_generator/nankai_questionnaire_generator.py
✅ 已有Excel生成器: survey_generator/nankai_excel_generator.py

需要调整:
- 在工商联门户添加"问卷生成"模块
- 指标变更时自动重新生成问卷
- 添加问卷版本管理
```

#### 3. 问卷模板管理
```
功能:
✅ 问卷模板上传
✅ 模板编辑
✅ 模板预览
✅ 模板版本管理

实现状态:
⚠️ 部分实现（问卷生成器支持模板）

需要添加:
- 模板管理界面
- 模板存储机制
- 模板应用到问卷生成
```

#### 4. 企业填报数据管理 ⭐
```
功能:
✅ 查看所有企业提交
✅ 查看企业得分
✅ 查看填报详情
✅ 导出企业数据
✅ 数据统计分析

实现状态:
✅ 已有提交管理: /api/portal/chamber/reviews
✅ 已有数据存储: storage/submissions/
✅ 已有Excel下载: /api/nankai/download/<id>

需要调整:
- 优化数据展示界面
- 添加筛选和搜索功能
```

#### 5. 自评报告模板管理 ⭐
```
功能:
✅ 报告模板上传
✅ 模板编辑
✅ 模板预览
✅ 模板版本管理

实现状态:
✅ 已有报告生成器: nankai_report_generator.py
⚠️ 模板固化在代码中

需要添加:
- 报告模板管理界面
- 模板可视化编辑
- 模板变量配置
```

#### 6. 企业自评报告管理
```
功能:
✅ 查看所有企业报告
✅ 按企业筛选
✅ 报告下载
✅ 报告统计

实现状态:
✅ 已有报告管理: /api/portal/chamber/all-reports
✅ 已有报告存储: storage/reports/

需要调整:
- 优化报告列表展示
- 添加报告预览功能
```

---

## 🏭 门户二：企业用户门户

### 登录信息
```
角色: enterprise
账号: ent / ent123
访问: http://localhost:5000/portal/enterprise
```

### 核心功能模块

#### 1. 问卷填报系统 ⭐
```
功能:
✅ 查看当前等级
✅ 填写对应等级问卷
✅ 分级填报（初级→中级→高级）
✅ 等级解锁机制（≥60分才能填下一级）
✅ 保存草稿
✅ 提交问卷

实现状态:
✅ 已有填报页面: /nankai-questionnaire-fill
✅ 已有提交接口: /api/nankai/submit
✅ 已有等级管理: user_levels.json

需要优化:
- 在企业门户添加"问卷填报"入口
- 显示等级解锁状态
- 显示填报进度
```

#### 2. 得分查看 ⭐
```
功能:
✅ 提交后立即显示得分
✅ 百分制得分展示
✅ 详细得分明细
✅ 各维度得分分析

实现状态:
✅ 已有评分引擎: nankai_scoring_engine.py
✅ 已有得分计算: /api/nankai/submit 返回得分
✅ 已有结果页面: /nankai-result

需要优化:
- 美化得分展示页面
- 添加得分趋势图
- 添加维度雷达图
```

#### 3. 自评报告生成与下载 ⭐
```
功能:
✅ 提交后自动生成报告
✅ 使用工商联提供的模板
✅ 页面显示下载链接
✅ 邮件发送报告

实现状态:
✅ 已有报告生成: nankai_report_generator.py
✅ 已有异步生成: generate_and_send_nankai_report_async()
✅ 已有邮件发送: notification_service.py
✅ 已有下载接口: /api/nankai/download-report/<filename>

需要优化:
- 在结果页面添加下载按钮
- 显示报告生成状态
- 添加报告预览功能
```

#### 4. 历史记录查询
```
功能:
✅ 查看所有提交记录
✅ 查看历史得分
✅ 下载历史报告
✅ 对比不同时期得分

实现状态:
✅ 已有历史接口: /api/enterprise/history
✅ 已有报告接口: /api/enterprise/reports

需要优化:
- 优化历史记录展示
- 添加时间轴视图
```

---

## 🔄 核心业务流程

### 流程1: 工商联管理指标和问卷
```
1. 工商联登录系统
2. 进入"评价指标管理"
3. 上传/编辑评价指标Excel
4. 系统自动生成三级问卷
5. 工商联预览问卷
6. 发布问卷供企业填写
```

### 流程2: 企业填报问卷
```
1. 企业登录系统
2. 查看当前等级（默认初级）
3. 点击"填写初级问卷"
4. 逐题填写（65题）
5. 点击"提交"按钮
6. 系统计算得分（如：68分）
7. 显示得分页面（百分制：68%）
8. 判断是否达标（≥60分）
   - 达标：解锁中级问卷
   - 不达标：提示需要改进
```

### 流程3: 自评报告生成
```
1. 企业提交问卷后
2. 系统异步生成自评报告
   - 使用工商联提供的模板
   - 填充企业数据和得分
   - 生成Word文档
3. 报告生成完成后
   - 在页面显示下载链接
   - 发送邮件到企业邮箱
   - 附件包含自评报告
```

### 流程4: 等级晋升
```
1. 企业完成初级问卷（得分68分）
2. 系统判定：达到升级标准
3. 企业可以填写中级问卷
4. 完成中级问卷（得分72分）
5. 系统判定：达到升级标准
6. 企业可以填写高级问卷
```

---

## 📊 当前实现状态对照表

| 功能模块 | 工商联需求 | 企业需求 | 实现状态 | 需要调整 |
|---------|-----------|---------|---------|---------|
| 评价指标管理 | ✅ | - | ✅ 已实现 | 移到工商联门户 |
| 问卷生成 | ✅ | - | ✅ 已实现 | 添加管理界面 |
| 问卷模板管理 | ✅ | - | ⚠️ 部分实现 | 添加模板管理 |
| 企业数据管理 | ✅ | - | ✅ 已实现 | 优化界面 |
| 报告模板管理 | ✅ | - | ⚠️ 部分实现 | 添加模板管理 |
| 企业报告管理 | ✅ | - | ✅ 已实现 | 优化界面 |
| 问卷填报 | - | ✅ | ✅ 已实现 | 添加到企业门户 |
| 等级解锁 | - | ✅ | ✅ 已实现 | 优化显示 |
| 得分查看 | - | ✅ | ✅ 已实现 | 美化界面 |
| 报告下载 | - | ✅ | ✅ 已实现 | 优化体验 |
| 邮件发送 | - | ✅ | ✅ 已实现 | 正常运行 |

---

## 🎯 需要完成的工作

### 高优先级 🔴

1. **工商联门户整合**
   - [ ] 将指标管理移到工商联门户
   - [ ] 添加问卷生成管理界面
   - [ ] 添加企业数据查看界面

2. **企业门户优化**
   - [ ] 添加问卷填报入口
   - [ ] 优化等级显示和解锁提示
   - [ ] 优化得分展示页面
   - [ ] 优化报告下载体验

3. **等级解锁机制**
   - [ ] 完善等级判定逻辑
   - [ ] 添加解锁状态显示
   - [ ] 添加不达标提示

### 中优先级 🟡

4. **模板管理系统**
   - [ ] 添加问卷模板管理
   - [ ] 添加报告模板管理
   - [ ] 实现模板可视化编辑

5. **数据统计分析**
   - [ ] 添加企业数据统计
   - [ ] 添加得分趋势分析
   - [ ] 添加维度对比图表

### 低优先级 🟢

6. **用户体验优化**
   - [ ] 添加填报进度保存
   - [ ] 添加报告预览功能
   - [ ] 添加历史对比功能

---

## 💻 技术实现建议

### 1. 工商联门户页面结构
```html
<!-- templates/portal_chamber.html -->
<div class="chamber-portal">
  <!-- 导航栏 -->
  <nav>
    <a href="#indicators">评价指标管理</a>
    <a href="#questionnaires">问卷生成管理</a>
    <a href="#templates">模板管理</a>
    <a href="#submissions">企业填报数据</a>
    <a href="#reports">企业报告管理</a>
  </nav>
  
  <!-- 评价指标管理 -->
  <section id="indicators">
    <button onclick="uploadIndicators()">上传指标</button>
    <button onclick="editIndicators()">编辑指标</button>
    <button onclick="generateQuestionnaires()">生成问卷</button>
  </section>
  
  <!-- 问卷生成管理 -->
  <section id="questionnaires">
    <div class="questionnaire-list">
      <div class="questionnaire-item">初级问卷 (65题)</div>
      <div class="questionnaire-item">中级问卷 (52题)</div>
      <div class="questionnaire-item">高级问卷 (42题)</div>
    </div>
  </section>
  
  <!-- 企业填报数据 -->
  <section id="submissions">
    <table class="submissions-table">
      <thead>
        <tr>
          <th>企业名称</th>
          <th>填报等级</th>
          <th>得分</th>
          <th>提交时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="submissions-list"></tbody>
    </table>
  </section>
</div>
```

### 2. 企业门户页面结构
```html
<!-- templates/portal_enterprise.html -->
<div class="enterprise-portal">
  <!-- 等级显示 -->
  <div class="level-status">
    <h3>当前等级: <span id="current-level">初级</span></h3>
  </div>
  
  <!-- 问卷填报 -->
  <section id="questionnaire-filling">
    <div class="level-cards">
      <!-- 初级 -->
      <div class="level-card" data-level="beginner">
        <h4>初级问卷</h4>
        <p>65题 | 基础指标</p>
        <button onclick="startQuestionnaire('beginner')">
          开始填写
        </button>
      </div>
      
      <!-- 中级 -->
      <div class="level-card locked" data-level="intermediate">
        <h4>中级问卷</h4>
        <p>52题 | 鼓励指标</p>
        <div class="lock-hint">
          🔒 需要初级得分≥60分解锁
        </div>
      </div>
      
      <!-- 高级 -->
      <div class="level-card locked" data-level="advanced">
        <h4>高级问卷</h4>
        <p>42题 | 拔高指标</p>
        <div class="lock-hint">
          🔒 需要中级得分≥60分解锁
        </div>
      </div>
    </div>
  </section>
  
  <!-- 历史记录 -->
  <section id="history">
    <table class="history-table">
      <thead>
        <tr>
          <th>填报时间</th>
          <th>等级</th>
          <th>得分</th>
          <th>报告</th>
        </tr>
      </thead>
      <tbody id="history-list"></tbody>
    </table>
  </section>
</div>
```

### 3. 等级解锁逻辑
```javascript
// 检查等级解锁状态
async function checkLevelUnlock() {
  const response = await fetch('/api/enterprise/level-status');
  const data = await response.json();
  
  // 初级：默认解锁
  unlockLevel('beginner');
  
  // 中级：需要初级≥60分
  if (data.beginner_score >= 60) {
    unlockLevel('intermediate');
  }
  
  // 高级：需要中级≥60分
  if (data.intermediate_score >= 60) {
    unlockLevel('advanced');
  }
}

function unlockLevel(level) {
  const card = document.querySelector(`[data-level="${level}"]`);
  card.classList.remove('locked');
  card.querySelector('button').disabled = false;
}
```

---

## 📝 总结

您的系统**已经实现了大部分核心功能**，主要需要：

1. ✅ **功能已实现**：问卷生成、在线填写、智能评分、报告生成、邮件发送
2. ⚠️ **需要整合**：将功能按门户重新组织界面
3. 🔧 **需要优化**：等级解锁显示、模板管理、数据统计

**建议实施步骤**：
1. 先优化企业门户（添加等级显示和解锁提示）
2. 再整合工商联门户（添加指标和模板管理）
3. 最后完善模板管理系统

您的系统架构合理，功能完整，只需要界面整合和用户体验优化！