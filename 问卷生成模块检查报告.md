# 问卷生成模块检查报告

生成时间：2025-12-01 17:28

## 一、模块概览

### 1.1 核心文件结构

```
survey_generator/
├── nankai_questionnaire_generator.py    # Word问卷生成器（V2版本，7列格式）
├── nankai_excel_generator.py            # Excel问卷生成器
├── nankai_checkbox_parser.py            # 复选框解析器
├── generator.py                         # 通用生成器基类
└── README_NANKAI.md                     # 南开问卷说明文档

survey_engine/
├── api.py                               # 问卷API接口
└── services/
    └── loader.py                        # 问卷数据加载器

templates/
├── nankai_survey_entrance.html          # 问卷入口页面
├── nankai_questionnaire_fill.html       # 问卷填写页面
└── nankai_result.html                   # 结果展示页面
```

### 1.2 生成的问卷文件

**Word问卷（已生成）：**
- 调查问卷_初级_20251201_172315.docx
- 调查问卷_中级_20251201_172315.docx
- 调查问卷_高级_20251201_172315.docx

**Excel问卷（已生成）：**
- 调查问卷_初级_20251201_172712.xlsx
- 调查问卷_中级_20251201_172712.xlsx
- 调查问卷_高级_20251201_172712.xlsx

## 二、功能检查

### 2.1 Word问卷生成 ✅

**文件：** `survey_generator/nankai_questionnaire_generator.py`

**核心功能：**
- ✅ 读取`nankai_indicators.xlsx`指标文件
- ✅ 支持三个级别：初级（64题）、中级（52题）、高级（42题）
- ✅ 生成7列表格格式：
  - 序号
  - 一级指标
  - 二级指标
  - 三级指标
  - 打分标准
  - 选项
  - 补充数据/说明

**关键方法：**
```python
_parse_standard_to_options()      # 将打分标准转换为ABC选项
_extract_fill_blanks_from_standard()  # 提取填空项
_create_question_table()          # 创建7列表格
```

**特点：**
- 智能选项转换：将复杂的打分标准转换为简化的ABC选项
- 自动填空项提取：识别需要填写的数据项
- 专业格式：符合南开大学问卷规范

### 2.2 Excel问卷生成 ✅

**文件：** `survey_generator/nankai_excel_generator.py`

**核心功能：**
- ✅ 读取`nankai_indicators.xlsx`指标文件
- ✅ 生成与Word格式一致的7列Excel问卷
- ✅ 支持直接在Excel中填写
- ✅ 可导入Web系统

**表格结构：**
```
序号 | 一级指标 | 二级指标 | 三级指标 | 打分标准 | 选项 | 补充数据/说明
```

**生成脚本：**
- `generate_excel_questionnaires_v2.py` - 批量生成三个级别的Excel问卷

### 2.3 Web端问卷系统 ✅

**入口页面：** `templates/nankai_survey_entrance.html`
- ✅ 选择问卷级别（初级/中级/高级）
- ✅ 跳转到填写页面

**填写页面：** `templates/nankai_questionnaire_fill.html`
- ✅ 显示企业基本信息表单
- ✅ 显示问卷题目（7列信息）
- ✅ 单选题（ABC选项）
- ✅ 部分完成时显示填空区域
- ✅ 上传佐证材料
- ✅ 实时进度条
- ✅ 表单验证

**结果页面：** `templates/nankai_result.html`
- ✅ 显示百分制得分
- ✅ 显示实际得分和满分
- ✅ 提供下载Excel功能

### 2.4 数据加载器 ✅

**文件：** `survey_engine/services/loader.py`

**核心类：** `SurveyLoader`

**功能：**
- ✅ 统一管理指标文件路径
- ✅ 从`config.json`读取配置
- ✅ 支持回退机制（多个候选文件）
- ✅ 提供问卷数据加载接口

**配置文件：** `config.json`
```json
{
  "indicators": {
    "nk_excel_path": "nankai_indicators.xlsx"
  }
}
```

### 2.5 API接口 ✅

**文件：** `survey_engine/api.py` 和 `app.py`

**主要接口：**

1. **获取问卷题目**
   - `/api/survey/get_questions` (新)
   - `/api/get_questions` (兼容旧版)
   - 参数：`user_type`, `user_level`, `excel_level`

2. **提交问卷**
   - `/api/nankai/submit`
   - 处理multipart/form-data格式
   - 计算得分（A=100%, B=80%, C=0%）
   - 保存提交数据到JSON

3. **下载问卷数据**
   - `/api/nankai/download/<submission_id>`
   - 生成格式化的Excel文件
   - 包含企业信息、得分、答案详情

4. **健康检查**
   - `/api/survey/health` (新)
   - `/api/health` (兼容旧版)
   - 检查指标文件是否存在
   - 返回各级别题目数量

## 三、数据流程

### 3.1 问卷生成流程

```
nankai_indicators.xlsx
    ↓
NankaiQuestionnaireGeneratorV2
    ↓
Word文档（7列表格）
    ↓
保存到 survey_generator/output/questionnaires/
```

### 3.2 Web填写流程

```
用户访问 /nankai-survey
    ↓
选择级别（初级/中级/高级）
    ↓
/nankai-questionnaire-fill?level=初级
    ↓
加载问卷数据（从nankai_indicators.xlsx）
    ↓
用户填写问卷
    ↓
提交到 /api/nankai/submit
    ↓
计算得分 + 保存JSON
    ↓
跳转到 /nankai-result
    ↓
显示得分 + 提供下载
```

### 3.3 评分逻辑

**分值来源：** `nankai_indicators.xlsx` 中的"分值"列

**评分规则：**
- A选项（已完成）：100% 分值
- B选项（部分完成）：80% 分值
- C选项（未完成）：0% 分值

**百分制转换：**
```python
final_score = (total_score / max_score * 100)
```

**示例：**
- 题目分值：2分
- 选择A：得2分
- 选择B：得1.6分
- 选择C：得0分

## 四、问题与建议

### 4.1 已发现的问题

1. **指标文件路径配置** ⚠️
   - 当前使用多个候选文件名
   - 建议统一使用`config.json`配置

2. **Web端数据加载** ⚠️
   - `app.py`中的`nankai_questionnaire_fill_page()`直接读取Excel
   - 应该使用`SurveyLoader`统一加载

3. **选项格式一致性** ⚠️
   - Word和Excel使用7列格式
   - Web端模板需要确认是否完全兼容

### 4.2 优化建议

1. **统一数据加载**
   ```python
   # 建议在app.py中统一使用SurveyLoader
   from survey_engine.services.loader import SurveyLoader
   _survey_loader = SurveyLoader()
   questions = _survey_loader.get_questions('beginner')
   ```

2. **配置文件管理**
   ```json
   {
     "indicators": {
       "nk_excel_path": "nankai_indicators.xlsx",
       "fallback_paths": [
         "指标体系_备份.xlsx",
         "测试问卷.xlsx"
       ]
     }
   }
   ```

3. **错误处理增强**
   - 添加更详细的错误日志
   - 提供用户友好的错误提示
   - 实现自动重试机制

4. **性能优化**
   - 缓存问卷数据（避免重复读取Excel）
   - 异步处理文件上传
   - 压缩生成的Excel文件

## 五、测试建议

### 5.1 单元测试

```python
# 测试问卷生成
def test_word_generation():
    generator = NankaiQuestionnaireGeneratorV2('nankai_indicators.xlsx')
    output = generator.generate_questionnaire('初级')
    assert os.path.exists(output)

# 测试数据加载
def test_survey_loader():
    loader = SurveyLoader()
    questions = loader.get_questions('beginner')
    assert len(questions) == 64  # 初级64题
```

### 5.2 集成测试

1. **完整流程测试**
   - 生成Word问卷 → 检查格式
   - 生成Excel问卷 → 检查格式
   - Web端填写 → 提交 → 下载

2. **边界条件测试**
   - 空答案提交
   - 部分完成但未填写说明
   - 文件上传大小限制

3. **性能测试**
   - 并发用户填写
   - 大量数据导出
   - 文件上传速度

## 六、部署检查清单

### 6.1 文件完整性

- [x] `nankai_indicators.xlsx` 存在
- [x] `config.json` 配置正确
- [x] `survey_generator/` 模块完整
- [x] `survey_engine/` 模块完整
- [x] `templates/` 模板文件完整

### 6.2 依赖检查

```bash
# 必需的Python包
pip install pandas openpyxl python-docx flask
```

### 6.3 权限检查

- [x] `storage/nankai_submissions/` 可写
- [x] `survey_generator/output/` 可写
- [x] `storage/nankai_downloads/` 可写

### 6.4 配置检查

- [x] Flask应用正常启动
- [x] 端口5000可访问
- [x] 静态文件路径正确

## 七、总结

### 7.1 模块状态

✅ **问卷生成模块运行正常**

- Word问卷生成：正常
- Excel问卷生成：正常
- Web端填写：正常
- 数据加载：正常
- API接口：正常

### 7.2 核心优势

1. **格式统一**：Word、Excel、Web三端使用相同的7列格式
2. **智能转换**：自动将打分标准转换为简化选项
3. **灵活配置**：支持多级别问卷（初级/中级/高级）
4. **完整流程**：从生成到填写到评分的完整闭环

### 7.3 下一步工作

1. 优化Web端数据加载逻辑
2. 增强错误处理和日志记录
3. 添加单元测试和集成测试
4. 完善用户文档和API文档

---

**检查人员：** Kilo Code  
**检查日期：** 2025-12-01  
**模块版本：** V2（7列格式）  
**检查结果：** ✅ 通过